<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EzyRide - GestiÃ³</title>
  <link rel="stylesheet" href="../../css/main.css">
  <script src="../../js/toast.js?v=1761166892"></script>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="../../images/logo.png" alt="Logo EzyRide">
      <h1>EzyRide</h1>
    </div>
    <div class="header-center"><h1 class="page-title">Dashboard</h1></div><div class="user-info" style="display: flex; gap: var(--spacing-md); align-items: center;">
      <!-- Selector de idioma -->
      <div class="language-selector" style="position: relative;">
        <button id="langBtn" class="btn btn-ghost" style="padding: var(--spacing-sm) var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-xs);">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/>
            <line x1="2" y1="12" x2="22" y2="12"/>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
          </svg>
          <span id="currentLangText">CA</span>
        </button>
        <div id="langMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 150px; padding: var(--spacing-xs); display: none; z-index: 1000;">
          <button onclick="changeLanguage('ca')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
            ðŸ‡ªðŸ‡¸ CatalÃ 
          </button>
          <button onclick="changeLanguage('es')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
            ðŸ‡ªðŸ‡¸ EspaÃ±ol
          </button>
          <button onclick="changeLanguage('en')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
            ðŸ‡¬ðŸ‡§ English
          </button>
        </div>
      </div>
      
      <!-- Dropdown de perfil -->
      <div style="position: relative;">
        <button id="profileDropdown" class="btn btn-ghost" style="display: flex; align-items: center; gap: var(--spacing-sm);">
          <div id="profileAvatar" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.875rem;">
            ...
          </div>
          <span id="profileUsername">Cargando...</span>
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div id="profileMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 220px; padding: var(--spacing-xs); display: none; z-index: 1000;">
          <a href="../profile/perfil.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            <span>El meu perfil</span>
          </a>
          <a href="../vehicle/purchase-time.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>Comprar Punts</span>
          </a>
          <a href="../profile/premium.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
            </svg>
            <span>Premium</span>
          </a>
          <hr style="margin: var(--spacing-sm) 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">
          <button onclick="logout()" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md); color: #EF4444;">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            <span>Tancar sessiÃ³</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container container-large fade-in">
      <!-- Benvinguda y Balance -->
      <div style="text-align: center; margin-bottom: var(--spacing-2xl);">
        
        <p style="color: var(--color-text-secondary); font-size: 1rem; margin-bottom: var(--spacing-xl);">
          Gestiona els teus vehicles i temps disponible
        </p>
        
        <!-- Balance Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-lg); max-width: 650px; margin: 0 auto;">
          <!-- EazyPoints Card -->
          <div class="card-glass" style="padding: var(--spacing-xl);">
            <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-sm);">
              EazyPoints
            </p>
            <div style="display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm);">
              <svg width="28" height="28" fill="none" stroke="#FFD700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="1"/>
                <circle cx="19" cy="12" r="1"/>
                <circle cx="5" cy="12" r="1"/>
                <circle cx="12" cy="5" r="1"/>
                <circle cx="12" cy="19" r="1"/>
              </svg>
              <p id="userPoints" style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent-primary) 0%, #FFD700 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
                0
              </p>
            </div>
            <p style="font-size: 0.75rem; color: var(--color-text-tertiary); text-align: center; margin-top: var(--spacing-xs);">
              punts disponibles
            </p>
          </div>

          <!-- Temps Disponible Card -->
          <div class="card-glass" style="padding: var(--spacing-xl);">
            <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-sm);">
              Temps disponible
            </p>
            <div style="display: flex; align-items: center; justify-content: center; gap: var(--spacing-sm);">
              <svg width="28" height="28" fill="none" stroke="var(--color-accent-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              <p id="timeAvailable" style="font-size: 2.5rem; font-weight: 700; color: var(--color-accent-primary); margin: 0;">
                0h
              </p>
            </div>
            <p style="font-size: 0.75rem; color: var(--color-text-tertiary); text-align: center; margin-top: var(--spacing-xs);">
              <span id="minutesDetail">0 minuts</span>
            </p>
          </div>
        </div>
      </div>

      <!-- Grid de Acciones -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-2xl);">
        
        <!-- Control Vehicle -->
        <a href="../vehicle/administrar-vehicle.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); transition: all var(--transition-base);">
          <div style="width: 60px; height: 60px; margin: 0 auto var(--spacing-md); background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/>
              <circle cx="7" cy="17" r="2"/>
              <path d="M9 17h6"/>
              <circle cx="17" cy="17" r="2"/>
            </svg>
          </div>
          <h3 style="text-align: center; margin-bottom: var(--spacing-sm); font-size: 1.125rem;">Control Vehicle</h3>
          <p style="text-align: center; color: var(--color-text-secondary); font-size: 0.875rem;">
            Administra i controla el teu vehicle
          </p>
        </a>

        <!-- Localitzar Vehicles -->
        <a href="../vehicle/localitzar-vehicle.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); transition: all var(--transition-base);">
          <div style="width: 60px; height: 60px; margin: 0 auto var(--spacing-md); background: linear-gradient(135deg, var(--color-accent-secondary) 0%, var(--color-accent-purple) 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
              <circle cx="12" cy="10" r="3"/>
            </svg>
          </div>
          <h3 style="text-align: center; margin-bottom: var(--spacing-sm); font-size: 1.125rem;">Localitzar Vehicles</h3>
          <p style="text-align: center; color: var(--color-text-secondary); font-size: 0.875rem;">
            Troba vehicles disponibles prop
          </p>
        </a>

        <!-- Comprar EazyPoints -->
        <a href="../vehicle/purchase-time.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); transition: all var(--transition-base); border: 2px solid rgba(255, 215, 0, 0.3);" id="comprarTempsCard">
          <div style="width: 60px; height: 60px; margin: 0 auto var(--spacing-md); background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="1"/>
              <circle cx="19" cy="12" r="1"/>
              <circle cx="5" cy="12" r="1"/>
              <circle cx="12" cy="5" r="1"/>
              <circle cx="12" cy="19" r="1"/>
            </svg>
          </div>
          <h3 style="text-align: center; margin-bottom: var(--spacing-sm); font-size: 1.125rem;">Comprar EazyPoints</h3>
          <p style="text-align: center; color: var(--color-text-secondary); font-size: 0.875rem;">
            Afegeix punts per llogar vehicles
          </p>
        </a>

        <!-- Perfil -->
        <a href="../profile/perfil.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); transition: all var(--transition-base);">
          <div style="width: 60px; height: 60px; margin: 0 auto var(--spacing-md); background: linear-gradient(135deg, #BF5AF2 0%, #FF6B9D 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </div>
          <h3 style="text-align: center; margin-bottom: var(--spacing-sm); font-size: 1.125rem;">Perfil</h3>
          <p style="text-align: center; color: var(--color-text-secondary); font-size: 0.875rem;">
            Gestiona el teu compte i preferÃ¨ncies
          </p>
        </a>

      </div>

      <!-- Enlaces rÃ¡pidos -->
      <div style="padding-top: var(--spacing-xl); border-top: 1px solid var(--color-border-default);">
        <div style="display: flex; justify-content: center; gap: var(--spacing-lg); flex-wrap: wrap;">
          <a href="../accessibility/accessibilitat.html" class="btn btn-ghost" style="font-size: 0.875rem;">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            Accessibilitat
          </a>
          <a href="resum-projecte.html" class="btn btn-ghost" style="font-size: 0.875rem;">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10 9 9 9 8 9"/>
            </svg>
            Resum del Projecte
          </a>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>Â© 2025 EzyRide. Tots els drets reservats.</p>
  </footer>

  <script>
    // FunciÃ³n para cargar puntos y tiempo disponible
    function loadPointsAndTime() {
      fetch('../../php/api/get-points.php', { 
        credentials: 'include' 
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Actualizar puntos
          const pointsElement = document.getElementById('userPoints');
          if (pointsElement) {
            pointsElement.textContent = data.points.toLocaleString('ca-ES');
          }
          
          // Actualizar tiempo disponible
          const timeElement = document.getElementById('timeAvailable');
          const minutesDetailElement = document.getElementById('minutesDetail');
          
          if (timeElement && data.minutes_available !== undefined) {
            const hours = data.hours_available || 0;
            const minutes = data.minutes_available || 0;
            
            if (hours >= 1) {
              timeElement.textContent = hours.toFixed(1) + 'h';
            } else {
              timeElement.textContent = minutes + ' min';
            }
            
            if (minutesDetailElement) {
              minutesDetailElement.textContent = minutes + ' minuts';
            }
          }
        }
      })
      .catch(error => {
        console.error('Error loading points:', error);
      });
    }

    document.addEventListener("DOMContentLoaded", function () {
      // Cargar puntos al inicio
      loadPointsAndTime();
      
      // Actualizar cada 30 segundos
      setInterval(loadPointsAndTime, 30000);

      // Obtener estado del booking
      fetch('../../php/api/get-booking-status.php', {
        credentials: 'include'
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const hasBooking = data.has_active_booking;
            const btnControl = document.querySelector('#controlVehicleCard');
            const btnComprarTemps = document.querySelector('#comprarTempsCard');
            
            if (hasBooking && btnControl) {
              btnControl.style.animation = 'pulse 2s infinite';
              btnControl.style.border = '2px solid var(--color-accent-primary)';
            } else if (!hasBooking && btnComprarTemps) {
              btnComprarTemps.style.animation = 'pulse 2s infinite';
              btnComprarTemps.style.border = '2px solid #FFD700';
            }
          }
        })
        .catch(error => {
          console.log('Booking status not available');
        });

      // Logout button
      const logoutButton = document.getElementById('logoutButton');
      if (logoutButton) {
        logoutButton.addEventListener('click', function (e) {
          e.preventDefault();
          fetch('../../php/api/logout.php', {
            method: 'POST',
            credentials: 'include'
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                window.location.href = '../../index.html';
              } else {
                showToast(data.message || 'Error en tancar la sessiÃ³.', 'error');
              }
            })
            .catch(() => {
              showToast('Error de connexiÃ³ amb el servidor.', 'error');
            });
        });
      }
    });

    // AnimaciÃ³n pulse
    const style = document.createElement('style');
    style.textContent = `
      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(166, 238, 54, 0.7);
        }
        50% {
          transform: scale(1.02);
          box-shadow: 0 0 0 10px rgba(166, 238, 54, 0);
        }
      }
    `;
    document.head.appendChild(style);
    
    // Inicializar dropdown de perfil
    function initProfileDropdown() {
      const profileBtn = document.getElementById('profileDropdown');
      const profileMenu = document.getElementById('profileMenu');
      const langMenu = document.getElementById('langMenu');
      
      if (profileBtn && profileMenu) {
        profileBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          profileMenu.style.display = profileMenu.style.display === 'none' ? 'block' : 'none';
          if (langMenu) langMenu.style.display = 'none';
        });
      }
      
      document.addEventListener('click', function() {
        if (profileMenu) profileMenu.style.display = 'none';
        if (langMenu) langMenu.style.display = 'none';
      });
      
      console.log('âœ… Dropdown de perfil inicializado');
    }

    // Cargar nombre de usuario
    function loadUsername() {
      fetch('../../php/api/session-check.php', { 
        credentials: 'include' 
      })
      .then(res => res.json())
      .then(data => {
        if (data.loggedIn && data.username) {
          const usernameEl = document.getElementById('profileUsername');
          const avatarEl = document.getElementById('profileAvatar');
          
          if (usernameEl) usernameEl.textContent = data.username;
          if (avatarEl) avatarEl.textContent = data.username.charAt(0).toUpperCase();
          
          console.log('âœ… Usuario cargado:', data.username);
        }
      })
      .catch(err => console.error('Error cargando usuario:', err));
    }

    // FunciÃ³n para cerrar sesiÃ³n
    function logout() {
      if (confirm('EstÃ s segur que vols tancar la sessiÃ³?')) {
        fetch('../../php/api/logout.php', { 
          method: 'POST',
          credentials: 'include' 
        })
        .then(() => {
          if (typeof showToast === 'function') {
            showToast('SessiÃ³ tancada correctament', 'success');
          }
          setTimeout(() => {
            window.location.href = '../auth/login.html';
          }, 1000);
        })
        .catch(err => {
          console.error('Error al cerrar sesiÃ³n:', err);
          window.location.href = '../auth/login.html';
        });
      }
    }
    
    // FunciÃ³n changeLanguage
    window.changeLanguage = function(lang) {
      localStorage.setItem('preferredLanguage', lang);
      document.getElementById('currentLangText').textContent = lang.toUpperCase();
      if (typeof showToast === 'function') {
        const messages = {
          'ca': 'Idioma canviat a CatalÃ ',
          'es': 'Idioma cambiado a EspaÃ±ol', 
          'en': 'Language changed to English'
        };
        showToast(messages[lang], 'success', 2000);
      }
      document.getElementById('langMenu').style.display = 'none';
    };
    
    // Inicializar al cargar
    initProfileDropdown();
    loadUsername();
  </script>
</body>
</html>
