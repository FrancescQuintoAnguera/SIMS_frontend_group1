<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - EazyRide</title>
    <link rel="stylesheet" href="../../css/main.css">
    <script src="../../js/translations.js" defer></script>
    <script src="../../js/toast.js?v=1761166892" defer></script>
</head>
<body>
    <!-- Header -->
    <div id="header-placeholder"></div>
    
    <!-- Main Content -->
    <div class="profile-page">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-avatar-large">
                <svg width="60" height="60" fill="white" viewBox="0 0 20 20">
                    <path d="M10 2C8.34 2 7 3.34 7 5C7 6.66 8.34 8 10 8C11.66 8 13 6.66 13 5C13 3.34 11.66 2 10 2ZM10 14C6.67 14 4 15.34 4 17V18H16V17C16 15.34 13.33 14 10 14Z"/>
                </svg>
            </div>
            <div class="profile-header-info">
                
                <p id="userEmail">Cargando...</p>
                <span class="badge badge-premium" id="premiumBadge" style="display:none;">
                    ‚≠ê <span data-i18n="profile.premium">Premium</span>
                </span>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="profile-grid">
            <!-- Points Card -->
            <div class="profile-card">
                <h2>
                    üíé <span data-i18n="profile.points">Puntos EazyRide</span>
                </h2>
                <div class="points-display">
                    <div class="points-label" data-i18n="buyPoints.currentBalance">Saldo Actual</div>
                    <div class="points-amount" id="userPoints">0</div>
                    <div class="points-label" data-i18n="buyPoints.points">puntos</div>
                </div>
                <div class="time-display">
                    <div class="points-label" data-i18n="profile.availableTime">Tiempo Disponible</div>
                    <div class="time-amount" id="availableTime">0h 0min</div>
                </div>
                <div class="profile-actions">
                    <a href="../vehicle/purchase-time.html" class="btn btn-primary">
                        <span data-i18n="nav.buyPoints">Comprar Puntos</span>
                    </a>
                </div>
            </div>

            <!-- Personal Info Card -->
            <div class="profile-card">
                <h2>
                    üë§ <span data-i18n="profile.personalInfo">Informaci√≥n Personal</span>
                </h2>
                <div class="profile-info-row">
                    <span class="profile-label" data-i18n="profile.name">Nombre</span>
                    <span class="profile-value" id="profileName">-</span>
                </div>
                <div class="profile-info-row">
                    <span class="profile-label" data-i18n="profile.email">Email</span>
                    <span class="profile-value" id="profileEmail">-</span>
                </div>
                <div class="profile-info-row">
                    <span class="profile-label" data-i18n="profile.phone">Tel√©fono</span>
                    <span class="profile-value" id="profilePhone">-</span>
                </div>
                <div class="profile-info-row">
                    <span class="profile-label" data-i18n="profile.license">Licencia</span>
                    <span class="profile-value" id="profileLicense">
                        <span class="badge badge-warning" data-i18n="profile.notVerified">No Verificado</span>
                    </span>
                </div>
                <div class="profile-actions">
                    <button class="btn btn-secondary" onclick="editProfile()">
                        <span data-i18n="profile.editProfile">Editar Perfil</span>
                    </button>
                </div>
            </div>

            <!-- Premium Status Card -->
            <div class="profile-card" id="premiumCard">
                <h2>
                    ‚≠ê <span data-i18n="profile.premium">Suscripci√≥n Premium</span>
                </h2>
                <div id="premiumStatus"></div>
                <div class="profile-actions">
                    <a href="premium.html" class="btn btn-premium" id="premiumBtn">
                        <span data-i18n="profile.activatePremium">Activar Premium</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="profile-card">
            <h2>üîó <span data-i18n="dashboard.quickActions">Acciones R√°pidas</span></h2>
            <div class="profile-actions">
                <a href="../vehicle/localitzar-vehicle.html" class="btn btn-primary">
                    <span data-i18n="dashboard.rentVehicle">Alquilar Veh√≠culo</span>
                </a>
                <a href="historial.html" class="btn btn-secondary">
                    <span data-i18n="dashboard.viewHistory">Ver Historial</span>
                </a>
                <a href="pagaments.html" class="btn btn-secondary">
                    <span data-i18n="profile.paymentMethods">M√©todos de Pago</span>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div id="footer-placeholder"></div>
    
    <script>
        // Load header & footer
        fetch('../../components/header.html')
            .then(r => r.text())
            .then(data => {
                document.getElementById('header-placeholder').innerHTML = data;
                // Set page title after header is loaded
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) {
                    pageTitle.textContent = 'El Meu Perfil';
                }
            });
        
        fetch('../../components/footer.html')
            .then(r => r.text())
            .then(data => document.getElementById('footer-placeholder').innerHTML = data);

        // Load profile data
        async function loadProfile() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '../auth/login.html';
                return;
            }

            try {
                const response = await fetch('../../php/profile/get_profile.php', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Error loading profile');

                const data = await response.json();
                
                // Update profile data
                document.getElementById('userName').textContent = data.nom || 'Usuario';
                document.getElementById('userEmail').textContent = data.email || '';
                document.getElementById('profileName').textContent = data.nom || '-';
                document.getElementById('profileEmail').textContent = data.email || '-';
                document.getElementById('profilePhone').textContent = data.telefon || '-';
                
                // License verification
                if (data.verificat_conduir) {
                    document.getElementById('profileLicense').innerHTML = 
                        `<span class="badge badge-success" data-i18n="profile.verified">Verificado</span>`;
                }

                // Load points
                loadPoints();
                
                // Check premium status
                checkPremiumStatus();

            } catch (error) {
                console.error('Error:', error);
                window.toast.error('Error al cargar el perfil');
            }
        }

        async function loadPoints() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('../../php/eazypoints/get_points.php', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const points = data.points || 0;
                    document.getElementById('userPoints').textContent = points;
                    
                    // Calculate available time (400 points = 30 min)
                    const minutes = Math.floor((points / 400) * 30);
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    document.getElementById('availableTime').textContent = `${hours}h ${mins}min`;
                }
            } catch (error) {
                console.error('Error loading points:', error);
            }
        }

        async function checkPremiumStatus() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('../../php/premium/check_status.php', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.is_premium) {
                        document.getElementById('premiumBadge').style.display = 'inline-block';
                        document.getElementById('premiumStatus').innerHTML = `
                            <div class="profile-info-row">
                                <span class="profile-label">Estado</span>
                                <span class="badge badge-success" data-i18n="profile.active">Activa</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-label">Tipo</span>
                                <span class="profile-value">${data.premium_type === 'yearly' ? 'Anual' : 'Mensual'}</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="profile-label">Vence</span>
                                <span class="profile-value">${new Date(data.expires_at).toLocaleDateString()}</span>
                            </div>
                        `;
                        document.getElementById('premiumBtn').innerHTML = '<span data-i18n="common.viewDetails">Ver Detalles</span>';
                    } else {
                        document.getElementById('premiumStatus').innerHTML = `
                            <div class="profile-info-row">
                                <span class="profile-label">Estado</span>
                                <span class="badge badge-warning" data-i18n="profile.inactive">Inactiva</span>
                            </div>
                            <p style="color: #666; margin-top: 1rem; font-size: 0.9rem;">
                                Desbloquea beneficios exclusivos con Premium
                            </p>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error checking premium:', error);
            }
        }

        function editProfile() {
            window.location.href = 'completar-perfil.html';
        }

        // Load on page load
        document.addEventListener('DOMContentLoaded', loadProfile);
    </script>
</body>
</html>
