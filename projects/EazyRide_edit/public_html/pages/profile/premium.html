<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzyRide - Subscripció Premium</title>
    <link rel="stylesheet" href="../../css/main.css">
    <script src="../../js/translations.js" defer></script>
    <script src="../../js/toast.js?v=1761166892" defer></script>
</head>
<body data-no-auto-layout>
    <header>
        <div class="logo-container">
            <a href="../dashboard/gestio.html" style="display: flex; align-items: center; gap: var(--spacing-md); text-decoration: none;">
                <img src="../../images/logo.png" alt="Logo EzyRide" style="height: 40px; width: 40px; border-radius: var(--radius-md);">
                <h1 style="margin: 0; font-size: 1.5rem; font-weight: 700;">EzyRide</h1>
            </a>
        </div>
        <div class="header-center"><h1 class="page-title">Premium</h1></div><div class="user-info" style="display: flex; align-items: center; gap: var(--spacing-md);">
            <!-- Selector de idioma -->
            <div class="language-selector" style="position: relative;">
                <button id="langBtn" class="btn btn-ghost" style="padding: var(--spacing-sm) var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-xs);">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    <span id="currentLangText">CA</span>
                </button>
                <div id="langMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 150px; padding: var(--spacing-xs); display: none; z-index: 1000;">
                    <button onclick="changeLanguage('ca')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇪🇸 Català
                    </button>
                    <button onclick="changeLanguage('es')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇪🇸 Español
                    </button>
                    <button onclick="changeLanguage('en')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇬🇧 English
                    </button>
                </div>
            </div>
            
            <!-- Dropdown de perfil -->
            <div style="position: relative;">
                <button id="profileDropdown" class="btn btn-ghost" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <div id="profileAvatar" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.875rem;">
                        ...
                    </div>
                    <span id="profileUsername">Cargando...</span>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div id="profileMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 220px; padding: var(--spacing-xs); display: none; z-index: 1000;">
                    <a href="perfil.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span>El meu perfil</span>
                    </a>
                    <a href="../vehicle/purchase-time.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Comprar Punts</span>
                    </a>
                    <a href="premium.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                        <span>Premium</span>
                    </a>
                    <hr style="margin: var(--spacing-sm) 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button onclick="logout()" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md); color: #EF4444;">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Tancar sessió</span>
                    </button>
                </div>
            </div>
            
            <a href="../dashboard/gestio.html" class="btn btn-ghost">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span data-i18n="management">Gestió</span>
            </a>
        </div>
    </header>

    <main>
        <div class="container container-large fade-in">
            <!-- Estado Premium Actual -->
            <div id="premiumStatus" style="display: none; margin-bottom: var(--spacing-xl);"></div>

            <!-- Título -->
            <div style="text-align: center; margin-bottom: var(--spacing-2xl);">
                <div class="icon-container icon-container-lg" style="background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%);">
                    <svg width="50" height="50" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                </div>
                <p style="color: var(--color-text-secondary); margin-top: var(--spacing-md);">Gaudeix de tots els avantatges amb una subscripció Premium</p>
            </div>

            <!-- Planes de Precio -->
            <div class="section">
                <h3 class="section-title">Escull el teu pla</h3>
                <div class="grid grid-auto" style="gap: var(--spacing-lg); max-width: 800px; margin: 0 auto;">
                    
                    <!-- Plan Mensual -->
                    <div onclick="selectPlan('monthly')" id="monthly-card" class="card-glass" style="cursor: pointer; padding: var(--spacing-xl); position: relative; transition: all 0.3s;">
                        <div style="text-align: center;">
                            <p style="font-size: 1.25rem; font-weight: 600; margin-bottom: var(--spacing-md);">Mensual</p>
                            <div style="margin-bottom: var(--spacing-lg);">
                                <span style="font-size: 3rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent-secondary) 0%, var(--color-accent-blue) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">4,99€</span>
                                <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-top: var(--spacing-xs);">/mes</p>
                            </div>
                            <div style="display: inline-block; padding: var(--spacing-xs) var(--spacing-md); background: rgba(105, 183, 240, 0.1); border-radius: var(--border-radius-full); color: var(--color-accent-secondary); font-size: 0.875rem; font-weight: 600;">
                                Flexible i sense compromís
                            </div>
                        </div>
                    </div>

                    <!-- Plan Anual -->
                    <div onclick="selectPlan('annual')" id="annual-card" class="card-glass" style="cursor: pointer; padding: var(--spacing-xl); position: relative; border: 2px solid var(--color-accent-primary); transition: all 0.3s;">
                        <span class="badge badge-success" style="position: absolute; top: var(--spacing-md); right: var(--spacing-md);">Estalvia 20€</span>
                        <div style="text-align: center;">
                            <p style="font-size: 1.25rem; font-weight: 600; margin-bottom: var(--spacing-md);">Anual</p>
                            <div style="margin-bottom: var(--spacing-lg);">
                                <span style="font-size: 3rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent-primary) 0%, #00C853 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">49,99€</span>
                                <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-top: var(--spacing-xs);">/any</p>
                                <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-top: var(--spacing-xs);">(~6,33€/mes)</p>
                            </div>
                            <div style="display: inline-block; padding: var(--spacing-xs) var(--spacing-md); background: rgba(166, 238, 54, 0.1); border-radius: var(--border-radius-full); color: var(--color-accent-primary); font-size: 0.875rem; font-weight: 600;">
                                Millor oferta - Recomanat
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Beneficios -->
            <div class="section">
                <h3 class="section-title">Avantatges Premium</h3>
                <div class="card-glass" style="padding: var(--spacing-lg);">
                    <div style="display: grid; gap: var(--spacing-md);">
                        
                        <div style="display: flex; align-items: start; gap: var(--spacing-md);">
                            <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, #00C853 100%); flex-shrink: 0;">
                                <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 var(--spacing-xs) 0; font-size: 1rem; font-weight: 600;">15% de descompte en tots els paquets</h4>
                                <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">Estalvia diners en cada compra de punts</p>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <div style="display: flex; align-items: start; gap: var(--spacing-md);">
                            <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, #00C853 100%); flex-shrink: 0;">
                                <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 var(--spacing-xs) 0; font-size: 1rem; font-weight: 600;">15 minuts gratuïts al dia</h4>
                                <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">200 punts de bonus cada dia</p>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <div style="display: flex; align-items: start; gap: var(--spacing-md);">
                            <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, #00C853 100%); flex-shrink: 0;">
                                <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 var(--spacing-xs) 0; font-size: 1rem; font-weight: 600;">Reducció de punts per hora</h4>
                                <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">900 punts/hora en lloc de 1000 punts/hora a partir de 2h</p>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <div style="display: flex; align-items: start; gap: var(--spacing-md);">
                            <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, #00C853 100%); flex-shrink: 0;">
                                <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 var(--spacing-xs) 0; font-size: 1rem; font-weight: 600;">Accés prioritari a vehicles</h4>
                                <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">Reserva preferent quan la flota és limitada</p>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <div style="display: flex; align-items: start; gap: var(--spacing-md);">
                            <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, #00C853 100%); flex-shrink: 0;">
                                <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 var(--spacing-xs) 0; font-size: 1rem; font-weight: 600;">Vehicles exclusius</h4>
                                <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">Cotxes amb millor autonomia només per a Premium</p>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <div style="display: flex; align-items: start; gap: var(--spacing-md);">
                            <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, #00C853 100%); flex-shrink: 0;">
                                <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                            </div>
                            <div>
                                <h4 style="margin: 0 0 var(--spacing-xs) 0; font-size: 1rem; font-weight: 600;">Atenció al client prioritària</h4>
                                <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">Xat o línia directa amb resposta ràpida</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- CTA Button -->
            <div style="text-align: center; margin-top: var(--spacing-2xl);">
                <button class="btn btn-primary" onclick="showConfirmationModal()" id="activateBtn" style="min-width: 300px; font-size: 1.125rem; padding: var(--spacing-lg) var(--spacing-xl);">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    Activar Subscripció Premium
                </button>
            </div>

        </div>
    </main>

    <!-- Modal de confirmación -->
    <div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; align-items: center; justify-content: center;">
        <div class="card-glass" style="max-width: 500px; width: 90%; padding: var(--spacing-2xl); margin: var(--spacing-lg);">
            <div style="text-align: center; margin-bottom: var(--spacing-xl);">
                <div class="icon-container icon-container-lg" style="background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%); margin: 0 auto var(--spacing-md);">
                    <svg width="40" height="40" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                </div>
                <h3 style="margin: 0 0 var(--spacing-sm) 0; font-size: 1.5rem;">Confirmar Subscripció Premium</h3>
            </div>
            
            <div style="background: rgba(105, 183, 240, 0.1); border: 1px solid rgba(105, 183, 240, 0.3); padding: var(--spacing-lg); border-radius: var(--radius-lg); margin-bottom: var(--spacing-lg);">
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md);">
                    <span style="color: var(--color-text-secondary);">Pla seleccionat:</span>
                    <span id="modalPlanType" style="font-weight: 600;"></span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-md);">
                    <span style="color: var(--color-text-secondary);">Preu:</span>
                    <span id="modalPrice" style="font-weight: 700; font-size: 1.25rem; color: var(--color-accent-primary);"></span>
                </div>
                <div class="divider" style="margin: var(--spacing-md) 0;"></div>
                <div style="font-size: 0.875rem; color: var(--color-text-secondary);">
                    <p style="margin: 0 0 var(--spacing-xs) 0;"><strong>Rebràs immediatament:</strong></p>
                    <ul style="margin: 0; padding-left: var(--spacing-lg);">
                        <li>200 punts de bonus (15 minuts gratis)</li>
                        <li>15% de descompte en tots els paquets</li>
                        <li>15 minuts gratuïts cada dia</li>
                        <li>Accés prioritari als vehicles</li>
                    </ul>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                <button onclick="closeConfirmModal()" class="btn btn-secondary" style="width: 100%;">
                    Cancel·lar
                </button>
                <button onclick="confirmPurchase()" class="btn btn-primary" id="confirmBtn" style="width: 100%;">
                    Confirmar i Activar
                </button>
            </div>
        </div>
    </div>

    <footer>
        <p data-i18n="rights">© 2025 EzyRide. Tots els drets reservats.</p>
    </footer>

    <script>
        // Variables globales
        let selectedPlan = 'monthly';
        const currentLang = 'ca'; // Idioma por defecto
        
        // Cargar usuario al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
            loadPremiumStatus();
            
            // Inicializar dropdowns
            const profileDropdown = document.getElementById('profileDropdown');
            const profileMenu = document.getElementById('profileMenu');
            
            if (profileDropdown && profileMenu) {
                profileDropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileMenu.style.display = profileMenu.style.display === 'none' ? 'block' : 'none';
                });
            }
            
            document.addEventListener('click', () => {
                if (profileMenu) profileMenu.style.display = 'none';
                const langMenu = document.getElementById('langMenu');
                if (langMenu) langMenu.style.display = 'none';
            });
        });
        
        // Cargar perfil de usuario
        async function loadUserProfile() {
            try {
                const response = await fetch('../../php/user/user-profile.php', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Network error');
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    const username = data.data.username || 'Usuario';
                    document.getElementById('profileUsername').textContent = username;
                    
                    // Avatar con iniciales
                    const initial = username.charAt(0).toUpperCase();
                    document.getElementById('profileAvatar').textContent = initial;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }
        
        // Función de logout
        function logout() {
            fetch('../../php/auth/logout.php', {
                method: 'POST',
                credentials: 'include'
            })
            .then(() => {
                window.location.href = '../auth/login.html';
            })
            .catch(error => {
                console.error('Error al cerrar sesión:', error);
                window.location.href = '../auth/login.html';
            });
        }
        
        // Inicializar selector de idioma
        document.getElementById('langBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            const menu = document.getElementById('langMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        });

        document.addEventListener('click', () => {
            const langMenu = document.getElementById('langMenu');
            if (langMenu) langMenu.style.display = 'none';
        });

        // Actualizar texto de idioma actual
        const currentLangTextEl = document.getElementById('currentLangText');
        if (currentLangTextEl) {
            currentLangTextEl.textContent = currentLang.toUpperCase();
        }

        // Cargar estado premium actual
        async function loadPremiumStatus() {
            try {
                const response = await fetch('../../php/api/get-points.php', {
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Network error');
                
                const data = await response.json();
                
                if (data.success && data.is_premium) {
                    showPremiumStatus(data);
                }
            } catch (error) {
                console.error('Error loading premium status:', error);
            }
        }

        function showPremiumStatus(data) {
            const statusDiv = document.getElementById('premiumStatus');
            const expiresDate = new Date(data.premium_expires_at);
            const daysLeft = Math.ceil((expiresDate - new Date()) / (1000 * 60 * 60 * 24));
            
            statusDiv.innerHTML = `
                <div class="card-glass" style="background: linear-gradient(135deg, rgba(166, 238, 54, 0.2) 0%, rgba(105, 183, 240, 0.2) 100%); border: 2px solid rgba(166, 238, 54, 0.6); padding: var(--spacing-xl);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                        <div style="font-size: 3rem;">✨</div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-accent-primary); font-size: 1.5rem;">✅ Ja ets usuari Premium!</h3>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">
                                La teva subscripció està <strong style="color: var(--color-accent-primary);">ACTIVA</strong> fins al <strong>${expiresDate.toLocaleDateString('ca-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</strong>
                            </p>
                            <p style="margin: var(--spacing-xs) 0 0 0; font-size: 0.875rem; color: var(--color-text-tertiary);">
                                Temps restant: ${daysLeft} dies
                            </p>
                        </div>
                        <div style="text-align: center; padding: var(--spacing-md); background: rgba(166, 238, 54, 0.1); border-radius: var(--radius-lg);">
                            <p style="font-size: 2rem; margin: 0; font-weight: 700; color: var(--color-accent-primary);">✓</p>
                            <p style="font-size: 0.75rem; margin: 0; color: var(--color-text-secondary);">ACTIU</p>
                        </div>
                    </div>
                </div>
            `;
            statusDiv.style.display = 'block';
            
            // Ocultar planes de precios
            const planesSection = document.querySelector('.section');
            if (planesSection) {
                planesSection.style.display = 'none';
            }
            
            // DESACTIVAR botón y cambiar texto
            const btn = document.getElementById('activateBtn');
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            btn.style.background = 'linear-gradient(135deg, #666 0%, #444 100%)';
            btn.innerHTML = `
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Subscripció Activa - Gaudeix dels teus beneficis!
            `;
            
            console.log('✅ Premium actiu mostrat - Botón desactivado');
        }

        function selectPlan(plan) {
            selectedPlan = plan;
            
            // Remover selección previa
            document.querySelectorAll('[id$="-card"]').forEach(card => {
                card.style.border = '';
                card.style.boxShadow = '';
            });
            
            // Añadir selección
            const selectedCard = document.getElementById(plan + '-card');
            if (plan === 'monthly') {
                selectedCard.style.border = '2px solid var(--color-accent-secondary)';
                selectedCard.style.boxShadow = '0 0 0 4px rgba(105, 183, 240, 0.2)';
            } else {
                selectedCard.style.border = '2px solid var(--color-accent-primary)';
                selectedCard.style.boxShadow = '0 0 0 4px rgba(166, 238, 54, 0.2)';
            }
            
            console.log('✅ Pla seleccionat:', plan);
        }

        function showConfirmationModal() {
            // Verificar que haya seleccionado un plan
            if (!selectedPlan) {
                showToast('Si us plau, selecciona un pla primer', 'error', 3000);
                return;
            }
            
            // Actualizar modal con información del plan
            const planNames = {
                'monthly': 'Mensual',
                'annual': 'Anual'
            };
            
            const prices = {
                'monthly': '4,99€',
                'annual': '49,99€'
            };
            
            document.getElementById('modalPlanType').textContent = planNames[selectedPlan];
            document.getElementById('modalPrice').textContent = prices[selectedPlan];
            
            // Mostrar modal
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'flex';
            
            console.log('✅ Modal de confirmación mostrado');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        async function confirmPurchase() {
            closeConfirmModal();
            await activatePremium();
        }

        async function activatePremium() {
            const btn = document.getElementById('activateBtn');
            
            // Verificar si el botón está desactivado (ya tiene premium)
            if (btn.disabled && btn.style.opacity === '0.5') {
                showToast('Ja tens una subscripció Premium activa!', 'info', 3000);
                return;
            }
            
            // Log para debugging
            console.log('🔍 Activando premium con tipo:', selectedPlan);
            
            // Guardar estado original del botón
            const originalHTML = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span style="display: inline-block; width: 20px; height: 20px; border: 3px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Processant...';

            try {
                const payload = {
                    type: selectedPlan
                };
                
                console.log('📤 Enviando payload:', payload);
                
                const response = await fetch('../../php/api/subscribe-premium.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('HTTP error ' + response.status);
                }

                const data = await response.json();
                
                console.log('📥 Resposta del servidor:', data);

                if (data.success) {
                    showToast(
                        '✨ Premium activat amb èxit! Has rebut ' + data.subscription.bonus_points + ' punts de bonus', 
                        'success', 
                        4000
                    );
                    
                    // Recargar después de 2 segundos para mostrar el nuevo estado
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showToast(
                        'Error: ' + (data.message || data.error || 'Error desconegut'), 
                        'error', 
                        5000
                    );
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de connexió. Si us plau, torna-ho a intentar.', 'error', 5000);
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // Cerrar modal al hacer click fuera
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('confirmModal');
            if (e.target === modal) {
                closeConfirmModal();
            }
        });

        // Seleccionar plan anual por defecto (mejor oferta)
        window.addEventListener('DOMContentLoaded', () => {
            selectPlan('annual');
            loadPremiumStatus();
        });
        
        // Agregar animación de spin
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>