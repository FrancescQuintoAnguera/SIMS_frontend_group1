<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eazy Ride - Perfil</title>
    <link rel="stylesheet" href="../../css/main.css">
    <script src="../../js/translations.js" defer></script>
    <script src="../../js/toast.js" defer></script>
</head>
<body data-no-auto-layout>
    <header>
        <div class="logo-container">
            <a href="../dashboard/gestio.html" style="display: flex; align-items: center; gap: var(--spacing-md); text-decoration: none;">
                <img src="../../images/logo.png" alt="Logo Eazy Ride" style="height: 40px; width: 40px; border-radius: var(--radius-md);">
                <h1 style="margin: 0; font-size: 1.5rem; font-weight: 700;">Eazy Ride</h1>
            </a>
        </div>
        <div class="user-info" style="display: flex; align-items: center; gap: var(--spacing-md);">
            <!-- Selector de idioma -->
            <div class="language-selector" style="position: relative;">
                <button id="langBtn" class="btn btn-ghost" style="padding: var(--spacing-sm) var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-xs);">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    <span id="currentLangText">CA</span>
                </button>
                <div id="langMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 150px; padding: var(--spacing-xs); display: none; z-index: 1000;">
                    <button onclick="changeLanguage('ca')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        üá™üá∏ Catal√†
                    </button>
                    <button onclick="changeLanguage('es')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        üá™üá∏ Espa√±ol
                    </button>
                    <button onclick="changeLanguage('en')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        üá¨üáß English
                    </button>
                </div>
            </div>
            
            <a href="../dashboard/gestio.html" class="btn btn-ghost">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span data-i18n="management">Gesti√≥</span>
            </a>
        </div>
    </header>

    <main>
        <div class="container container-large fade-in">
            <!-- T√≠tulo -->
            <div style="text-align: center; margin-bottom: var(--spacing-2xl);">
                <div class="icon-container icon-container-lg" style="background: linear-gradient(135deg, #BF5AF2 0%, #FF6B9D 100%);">
                    <svg width="50" height="50" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                <h2 style="margin-bottom: var(--spacing-sm);" data-i18n="my_profile">El Meu Perfil</h2>
                <p style="color: var(--color-text-secondary);">Gestiona la teva informaci√≥ personal</p>
            </div>

            <!-- Estado Premium (si aplica) -->
            <div id="premiumStatus" style="display: none; margin-bottom: var(--spacing-xl);"></div>
            
            <!-- Bonus Diario Premium -->
            <div id="dailyBonusSection" style="display: none; margin-bottom: var(--spacing-xl);"></div>

            <!-- Saldo EazyPoints -->
            <div class="card-glass" style="margin-bottom: var(--spacing-xl); padding: var(--spacing-xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                    <div style="flex: 1; min-width: 200px;">
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Saldo EazyPoints</p>
                        <p style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent-primary) 0%, #FFD700 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
                            <span id="userPoints">0</span> <span style="font-size: 1.5rem;" data-i18n="points">pts</span>
                        </p>
                        <p style="font-size: 0.875rem; color: var(--color-text-tertiary); margin-top: var(--spacing-xs);">
                            <span data-i18n="available_time">Temps disponible:</span> <strong id="timeAvailable">0h 0min</strong>
                        </p>
                    </div>
                    <a href="../vehicle/purchase-time.html" class="btn btn-primary">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span data-i18n="buy_points">Comprar Punts</span>
                    </a>
                </div>
            </div>

            <!-- Dades Personals -->
            <div class="section">
                <h3 class="section-title" data-i18n="personal_info">Dades Personals</h3>
                <div class="card-glass">
                    <div style="display: grid; gap: var(--spacing-md);">
                        <!-- Nom -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="full_name">Nom complet:</span>
                            <span id="fullname_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                        <div class="divider" style="margin: 0;"></div>
                        
                        <!-- DNI -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="dni">DNI/NIE:</span>
                            <span id="dni_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                        <div class="divider" style="margin: 0;"></div>
                        
                        <!-- Tel√®fon -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="phone">Tel√®fon:</span>
                            <span id="phone_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                        <div class="divider" style="margin: 0;"></div>
                        
                        <!-- Data naixement -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="birth_date">Data de naixement:</span>
                            <span id="birthdate_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                        <div class="divider" style="margin: 0;"></div>
                        
                        <!-- Adre√ßa -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="address">Adre√ßa:</span>
                            <span id="address_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                        <div class="divider" style="margin: 0;"></div>
                        
                        <!-- Sexe -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="gender">Sexe:</span>
                            <span id="sex_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                        <button id="editBtn" class="btn btn-primary" style="flex: 1;">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            <span data-i18n="edit">Editar</span>
                        </button>
                        <button id="saveBtn" class="btn btn-primary" style="flex: 1; display: none; background: linear-gradient(135deg, #00C853 0%, #00A845 100%);">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span data-i18n="save">Guardar</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Accions R√†pides -->
            <div class="section">
                <h3 class="section-title">Subscripci√≥ i Avantatges</h3>
                <div class="grid grid-auto" style="gap: var(--spacing-lg);">
                    
                    <!-- Premium -->
                    <a href="premium.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); text-align: center; cursor: pointer; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 193, 7, 0.1) 100%); border: 2px solid rgba(255, 215, 0, 0.4);">
                        <div class="icon-container" style="background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%);">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                        </div>
                        <h4 style="margin-bottom: var(--spacing-xs); font-size: 1.1rem; color: #FFD700;" data-i18n="premium">Premium</h4>
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">15% desc. + 15 min diaris</p>
                    </a>

                    <!-- Completar Perfil -->
                    <a href="completar-perfil.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); text-align: center; cursor: pointer;">
                        <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-secondary) 0%, var(--color-accent-purple) 100%);">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <h4 style="margin-bottom: var(--spacing-xs); font-size: 1rem;">Completar Perfil</h4>
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">Afegeix m√©s informaci√≥</p>
                    </a>

                    <!-- Verificar Carnet -->
                    <a href="verificar-conduir.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); text-align: center; cursor: pointer;">
                        <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-blue) 0%, var(--color-accent-secondary) 100%);">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                            </svg>
                        </div>
                        <h4 style="margin-bottom: var(--spacing-xs); font-size: 1rem;">Verificar Carnet</h4>
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">Valida la teva llic√®ncia</p>
                    </a>

                    <!-- Hist√≤ric Viatges -->
                    <a href="historial.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); text-align: center; cursor: pointer;">
                        <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%);">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                        <h4 style="margin-bottom: var(--spacing-xs); font-size: 1rem;">Hist√≤ric Viatges</h4>
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">Revisa els teus viatges</p>
                    </a>

                    <!-- Pagaments -->
                    <a href="pagaments.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); text-align: center; cursor: pointer;">
                        <div class="icon-container" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                        </div>
                        <h4 style="margin-bottom: var(--spacing-xs); font-size: 1rem;">Pagaments</h4>
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">Gestiona els teus m√®todes</p>
                    </a>

                </div>
            </div>
        </div>
    </main>

    <footer>
        <p data-i18n="rights">¬© 2025 Eazy Ride. Tots els drets reservats.</p>
    </footer>

    <script>
// Todo dentro de DOMContentLoaded para asegurar que el DOM est√° listo
document.addEventListener('DOMContentLoaded', function () {
  console.log('Perfil: P√°gina cargada');
  
  // Inicializar selector de idioma
  const langBtn = document.getElementById('langBtn');
  const langMenu = document.getElementById('langMenu');
  const currentLangText = document.getElementById('currentLangText');
  
  if (langBtn && langMenu) {
    langBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      langMenu.style.display = langMenu.style.display === 'none' ? 'block' : 'none';
    });
    
    document.addEventListener('click', () => {
      langMenu.style.display = 'none';
    });
  }

  // Actualizar texto de idioma actual con fallback
  if (currentLangText) {
    const lang = (typeof currentLang !== 'undefined') ? currentLang.toUpperCase() : 'CA';
    currentLangText.textContent = lang;
  }

  const fields = ['fullname', 'dni', 'phone', 'birthdate', 'address', 'sex'];
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  let profileData = {};

  // Cargar datos inmediatamente
  console.log('Perfil: Iniciando carga de datos...');
  loadPremiumStatus();
  loadPoints();
  loadProfileData();

  function loadProfileData() {
    console.log('Perfil: Cargando datos personales...');
    
    fetch('../../php/api/completar-perfil.php', { 
      credentials: 'include',
      headers: {
        'Cache-Control': 'no-cache'
      }
    })
      .then(res => {
        console.log('Perfil: Respuesta del servidor:', res.status);
        if (!res.ok) {
          throw new Error('HTTP error ' + res.status);
        }
        return res.json();
      })
      .then(data => {
        console.log('Perfil: Datos recibidos:', data);
        
        if (data.success && data.data) {
          profileData = data.data;
          
          fields.forEach(f => {
            const span = document.getElementById(f + '_span');
            if (span) {
              let value = 'No definit';
              
              if (f === 'fullname') {
                value = data.data[f] || data.data.username || 'No definit';
              } else if (data.data[f] !== undefined && data.data[f] !== null && data.data[f] !== '') {
                value = data.data[f];
              }
              
              span.textContent = value;
              console.log('Perfil: ' + f + ' = ' + value);
            } else {
              console.warn('Perfil: No se encontr√≥ elemento ' + f + '_span');
            }
          });
        } else {
          console.error('Perfil: Error en datos -', data.message || 'Sin mensaje');
          fields.forEach(f => {
            const span = document.getElementById(f + '_span');
            if (span) span.textContent = 'Error de c√†rrega';
          });
        }
      })
      .catch(err => {
        console.error('Perfil: Error cargando datos:', err);
        fields.forEach(f => {
          const span = document.getElementById(f + '_span');
          if (span) span.textContent = 'Error de c√†rrega';
        });
      });
  }
        if (span) span.textContent = 'Error de c√†rrega';
      });
    });

  function loadPremiumStatus() {
    fetch('../../php/api/get-points.php', { credentials: 'include' })
      .then(res => {
        if (!res.ok) throw new Error('Network error');
        return res.json();
      })
      .then(data => {
        if (data.success && data.is_premium) {
          const expiresDate = new Date(data.premium_expires_at);
          const now = new Date();
          const daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));
          
          const langCode = currentLang || 'ca';
          const locale = langCode === 'ca' ? 'ca-ES' : (langCode === 'es' ? 'es-ES' : 'en-US');
          
          const statusDiv = document.getElementById('premiumStatus');
          statusDiv.innerHTML = `
            <div class="card-glass" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 193, 7, 0.2) 100%); border: 2px solid rgba(255, 215, 0, 0.6); padding: var(--spacing-lg);">
              <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                <div style="font-size: 2rem;">‚≠ê</div>
                <div style="flex: 1;">
                  <h4 style="margin: 0 0 var(--spacing-xs) 0; color: #FFD700;">${t('profile.premium_active')}</h4>
                  <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">
                    ${t('profile.premium_expires')} ${expiresDate.toLocaleDateString(locale)} (${daysLeft} ${t('profile.days_remaining')})
                  </p>
                </div>
              </div>
            </div>
          `;
          statusDiv.style.display = 'block';
          
          // Cargar estado del bonus diario
          loadDailyBonusStatus();
        }
      })
      .catch(err => console.error('Error loading premium status:', err));
  }
  
  function loadDailyBonusStatus() {
    fetch('../../php/api/check-daily-bonus.php', { credentials: 'include' })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.is_premium) {
          const bonusDiv = document.getElementById('dailyBonusSection');
          
          if (data.can_claim) {
            bonusDiv.innerHTML = `
              <div class="card-glass" style="background: linear-gradient(135deg, rgba(166, 238, 54, 0.2) 0%, rgba(105, 183, 240, 0.2) 100%); border: 2px solid rgba(166, 238, 54, 0.6); padding: var(--spacing-lg);">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-md);">
                  <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <div style="font-size: 2rem;">üéÅ</div>
                    <div>
                      <h4 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-accent-primary);">Bonus Diari Disponible!</h4>
                      <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">
                        Reclama els teus 200 punts gratu√Øts (15 minuts)
                      </p>
                    </div>
                  </div>
                  <button onclick="claimDailyBonus()" class="btn btn-primary" style="min-width: 150px;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                      <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Reclamar
                  </button>
                </div>
              </div>
            `;
          } else if (data.last_claimed) {
            const nextDate = new Date(data.next_bonus);
            bonusDiv.innerHTML = `
              <div class="card-glass" style="padding: var(--spacing-lg);">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                  <div style="font-size: 2rem;">‚úÖ</div>
                  <div>
                    <h4 style="margin: 0 0 var(--spacing-xs) 0;">Bonus Diari Reclamat</h4>
                    <p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">
                      Torna dem√† ${nextDate.toLocaleDateString('ca-ES')} per m√©s punts gratu√Øts!
                    </p>
                  </div>
                </div>
              </div>
            `;
          }
          
          bonusDiv.style.display = 'block';
        }
      })
      .catch(err => console.error('Error loading daily bonus:', err));
  }
  
  function claimDailyBonus() {
    fetch('../../php/api/claim-daily-bonus.php', {
      method: 'POST',
      credentials: 'include'
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast('Bonus diari reclamat! +200 punts', 'success');
          loadPoints();
          loadDailyBonusStatus();
        } else {
          showToast(data.message || 'Error al reclamar el bonus', 'error');
        }
      })
      .catch(err => {
        console.error('Error claiming bonus:', err);
        showToast('Error de connexi√≥', 'error');
      });
  }

  function loadPoints() {
    console.log('Cargando puntos del usuario...');
    
    fetch('../../php/api/get-points.php', { 
      credentials: 'include',
      headers: {
        'Cache-Control': 'no-cache'
      }
    })
      .then(res => {
        console.log('Respuesta get-points:', res.status);
        if (!res.ok) throw new Error('Network error ' + res.status);
        return res.json();
      })
      .then(data => {
        console.log('Datos de puntos recibidos:', data);
        
        if (data.success) {
          const points = data.points || 0;
          const minutes = data.minutes_available || 0;
          const hours = Math.floor(minutes / 60);
          const mins = minutes % 60;
          
          const userPointsEl = document.getElementById('userPoints');
          const timeAvailableEl = document.getElementById('timeAvailable');
          
          if (userPointsEl) {
            userPointsEl.textContent = points.toLocaleString('ca-ES');
            console.log('Puntos actualizados:', points);
          }
          
          if (timeAvailableEl) {
            timeAvailableEl.textContent = `${hours}h ${mins}min`;
            console.log('Tiempo disponible:', `${hours}h ${mins}min`);
          }
        } else {
          console.error('Error en respuesta:', data.message);
          
          const userPointsEl = document.getElementById('userPoints');
          const timeAvailableEl = document.getElementById('timeAvailable');
          
          if (userPointsEl) userPointsEl.textContent = '0';
          if (timeAvailableEl) timeAvailableEl.textContent = '0h 0min';
        }
      })
      .catch(err => {
        console.error('Error loading points:', err);
        
        const userPointsEl = document.getElementById('userPoints');
        const timeAvailableEl = document.getElementById('timeAvailable');
        
        if (userPointsEl) userPointsEl.textContent = '0';
        if (timeAvailableEl) timeAvailableEl.textContent = '0h 0min';
      });
  }

  // Edit button click
  editBtn.addEventListener('click', () => {
    fields.forEach(f => {
      const span = document.getElementById(f + '_span');
      const currentValue = span.textContent === t('not_defined') ? '' : span.textContent;
      
      // Create appropriate input
      let input;
      if (f === 'sex') {
        input = document.createElement('select');
        input.className = 'form-input';
        input.innerHTML = `
          <option value="">Selecciona</option>
          <option value="M" ${currentValue === 'M' ? 'selected' : ''}>Home</option>
          <option value="F" ${currentValue === 'F' ? 'selected' : ''}>Dona</option>
          <option value="O" ${currentValue === 'O' ? 'selected' : ''}>Altres</option>
        `;
      } else {
        input = document.createElement('input');
        input.type = f === 'birthdate' ? 'date' : (f === 'phone' ? 'tel' : 'text');
        input.value = (f === 'fullname' && currentValue === profileData.username) ? '' : currentValue;
        input.className = 'form-input';
      }
      
      input.id = 'input_' + f;
      input.style.width = '100%';
      input.style.textAlign = 'right';
      
      // Wrap in container for alignment
      const container = span.parentElement;
      span.replaceWith(input);
    });

    editBtn.style.display = 'none';
    saveBtn.style.display = 'flex';
  });

  // Save button click
  saveBtn.addEventListener('click', () => {
    const updatedData = {};
    let hasErrors = false;

    fields.forEach(f => {
      const input = document.getElementById('input_' + f);
      updatedData[f] = input.value.trim();
    });

    // Validation
    if (!updatedData.fullname) {
      showToast(t('error_occurred') + ': El nom complet √©s obligatori', 'error');
      hasErrors = true;
      return;
    }

    if (hasErrors) return;

    fetch('../../php/api/completar-perfil.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(updatedData)
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast(t('profile_updated'), 'success');
          
          fields.forEach(f => {
            const input = document.getElementById('input_' + f);
            const span = document.createElement('span');
            span.id = f + '_span';
            span.style.fontWeight = '600';

            if (f === 'fullname') {
              span.textContent = updatedData[f] || profileData.username || t('not_defined');
              profileData.fullname = updatedData[f] || null;
            } else {
              span.textContent = updatedData[f] || t('not_defined');
              profileData[f] = updatedData[f];
            }

            input.replaceWith(span);
          });

          editBtn.style.display = 'flex';
          saveBtn.style.display = 'none';
        } else {
          showToast(data.message || t('error_occurred'), 'error');
        }
      })
      .catch(err => {
        console.error('Error:', err);
        showToast(t('connection_error'), 'error');
      });
  });
});
    </script>
</body>
</html>