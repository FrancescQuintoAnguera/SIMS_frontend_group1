<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzyRide - Perfil</title>
    <link rel="stylesheet" href="../../css/main.css">
    <script src="../../js/translations.js" defer></script>
    <script src="../../js/toast.js?v=1761166892" defer></script>
</head>
<body data-no-auto-layout>
    <header>
        <div class="logo-container">
            <a href="../dashboard/gestio.html" style="display: flex; align-items: center; gap: var(--spacing-md); text-decoration: none;">
                <img src="../../images/logo.png" alt="Logo EzyRide" style="height: 40px; width: 40px; border-radius: var(--radius-md);">
                <h1 style="margin: 0; font-size: 1.5rem; font-weight: 700;">EzyRide</h1>
            </a>
        </div>
        <div class="header-center"><h1 class="page-title">El Meu Perfil</h1></div><div class="user-info" style="display: flex; align-items: center; gap: var(--spacing-md);">
            <!-- Selector de idioma -->
            <div class="language-selector" style="position: relative;">
                <button id="langBtn" class="btn btn-ghost" style="padding: var(--spacing-sm) var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-xs);">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    <span id="currentLangText">CA</span>
                </button>
                <div id="langMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 150px; padding: var(--spacing-xs); display: none; z-index: 1000;">
                    <button onclick="changeLanguage('ca')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇪🇸 Català
                    </button>
                    <button onclick="changeLanguage('es')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇪🇸 Español
                    </button>
                    <button onclick="changeLanguage('en')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇬🇧 English
                    </button>
                </div>
            </div>
            
            <!-- Dropdown de perfil -->
            <div style="position: relative;">
                <button id="profileDropdown" class="btn btn-ghost" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <div id="profileAvatar" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.875rem;">
                        K
                    </div>
                    <span id="profileUsername">Karchopo</span>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div id="profileMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 220px; padding: var(--spacing-xs); display: none; z-index: 1000;">
                    <a href="../profile/perfil.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span>El meu perfil</span>
                    </a>
                    <a href="../vehicle/purchase-time.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Comprar Punts</span>
                    </a>
                    <a href="../profile/premium.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                        <span>Premium</span>
                    </a>
                    <hr style="margin: var(--spacing-sm) 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button onclick="logout()" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md); color: #EF4444;">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Tancar sessió</span>
                    </button>
                </div>
            </div>
            
            <a href="../dashboard/gestio.html" class="btn btn-ghost">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span data-i18n="management">Gestió</span>
            </a>
        </div>
    </header>

    <main>
        <div class="container container-large fade-in">
            <!-- Título -->
            <div style="text-align: center; margin-bottom: var(--spacing-2xl);">
                <div class="icon-container icon-container-lg" style="background: linear-gradient(135deg, #BF5AF2 0%, #FF6B9D 100%);">
                    <svg width="50" height="50" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </div>
                
                <p style="color: var(--color-text-secondary);">Gestiona la teva informació personal</p>
            </div>

            <!-- Estado Premium (si aplica) -->
            <div id="premiumStatus" style="display: none; margin-bottom: var(--spacing-xl);"></div>
            
            <!-- Bonus Diario Premium -->
            <div id="dailyBonusSection" style="display: none; margin-bottom: var(--spacing-xl);"></div>

            <!-- Saldo EazyPoints -->
            <div class="card-glass" style="margin-bottom: var(--spacing-xl); padding: var(--spacing-xl);">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                    <div style="flex: 1; min-width: 200px;">
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Saldo EazyPoints</p>
                        <p style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent-primary) 0%, #FFD700 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
                            <span id="userPoints">0</span> <span style="font-size: 1.5rem;" data-i18n="points">pts</span>
                        </p>
                        <p style="font-size: 0.875rem; color: var(--color-text-tertiary); margin-top: var(--spacing-xs);">
                            <span data-i18n="available_time">Temps disponible:</span> <strong id="timeAvailable">0h 0min</strong>
                        </p>
                    </div>
                    <a href="../vehicle/purchase-time.html" class="btn btn-primary">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span data-i18n="buy_points">Comprar Punts</span>
                    </a>
                </div>
            </div>

            <!-- Dades Personals -->
            <div class="section">
                <h3 class="section-title" data-i18n="personal_info">Dades Personals</h3>
                <div class="card-glass">
                    <div style="display: grid; gap: var(--spacing-md);">
                        <!-- Nom -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="full_name">Nom complet:</span>
                            <span id="fullname_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                        <div class="divider" style="margin: 0;"></div>
                        
                        <!-- DNI -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="dni">DNI/NIE:</span>
                            <span id="dni_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                        <div class="divider" style="margin: 0;"></div>
                        
                        <!-- Telèfon -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="phone">Telèfon:</span>
                            <span id="phone_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                        <div class="divider" style="margin: 0;"></div>
                        
                        <!-- Data naixement -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="birth_date">Data de naixement:</span>
                            <span id="birthdate_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                        <div class="divider" style="margin: 0;"></div>
                        
                        <!-- Adreça -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="address">Adreça:</span>
                            <span id="address_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                        <div class="divider" style="margin: 0;"></div>
                        
                        <!-- Sexe -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--color-text-secondary);" data-i18n="gender">Sexe:</span>
                            <span id="sex_span" style="font-weight: 600;" data-i18n="loading">Carregant...</span>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                        <button id="editBtn" class="btn btn-primary" style="flex: 1;">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            <span data-i18n="edit">Editar</span>
                        </button>
                        <button id="saveBtn" class="btn btn-primary" style="flex: 1; display: none; background: linear-gradient(135deg, #00C853 0%, #00A845 100%);">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span data-i18n="save">Guardar</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Accions Ràpides -->
            <div class="section">
                <h3 class="section-title">Subscripció i Avantatges</h3>
                <div class="grid grid-auto" style="gap: var(--spacing-lg);">
                    
                    <!-- Premium -->
                    <a href="premium.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); text-align: center; cursor: pointer; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 193, 7, 0.1) 100%); border: 2px solid rgba(255, 215, 0, 0.4);">
                        <div class="icon-container" style="background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%);">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                        </div>
                        <h4 style="margin-bottom: var(--spacing-xs); font-size: 1.1rem; color: #FFD700;" data-i18n="premium">Premium</h4>
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">15% desc. + 15 min diaris</p>
                    </a>

                    <!-- Completar Perfil -->
                    <a href="completar-perfil.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); text-align: center; cursor: pointer;">
                        <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-secondary) 0%, var(--color-accent-purple) 100%);">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <h4 style="margin-bottom: var(--spacing-xs); font-size: 1rem;">Completar Perfil</h4>
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">Afegeix més informació</p>
                    </a>

                    <!-- Verificar Carnet -->
                    <a href="verificar-conduir.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); text-align: center; cursor: pointer;">
                        <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-blue) 0%, var(--color-accent-secondary) 100%);">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                            </svg>
                        </div>
                        <h4 style="margin-bottom: var(--spacing-xs); font-size: 1rem;">Verificar Carnet</h4>
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">Valida la teva llicència</p>
                    </a>

                    <!-- Històric Viatges -->
                    <a href="historial.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); text-align: center; cursor: pointer;">
                        <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%);">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                        <h4 style="margin-bottom: var(--spacing-xs); font-size: 1rem;">Històric Viatges</h4>
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">Revisa els teus viatges</p>
                    </a>

                    <!-- Pagaments -->
                    <a href="pagaments.html" class="card-glass" style="text-decoration: none; padding: var(--spacing-xl); text-align: center; cursor: pointer;">
                        <div class="icon-container" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                        </div>
                        <h4 style="margin-bottom: var(--spacing-xs); font-size: 1rem;">Pagaments</h4>
                        <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">Gestiona els teus mètodes</p>
                    </a>

                </div>
            </div>
        </div>
    </main>

    <footer>
        <p data-i18n="rights">© 2025 EzyRide. Tots els drets reservats.</p>
    <script>
// Script corregido para perfil.html
document.addEventListener('DOMContentLoaded', function () {
  console.log('✅ Perfil: Página cargada');
  
  // Inicializar selector de idioma
  const langBtn = document.getElementById('langBtn');
  const langMenu = document.getElementById('langMenu');
  const currentLangText = document.getElementById('currentLangText');
  
  if (langBtn && langMenu) {
    langBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      langMenu.style.display = langMenu.style.display === 'none' ? 'block' : 'none';
    });
    
    document.addEventListener('click', () => {
      if (langMenu) langMenu.style.display = 'none';
    });
  }

  if (currentLangText) {
    currentLangText.textContent = 'CA';
  }

  const fields = ['fullname', 'dni', 'phone', 'birthdate', 'address', 'sex'];
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  let profileData = {};

  // CARGAR DATOS INMEDIATAMENTE
  console.log('⏳ Cargando datos...');
  loadProfileData();
  loadPoints();
  loadPremiumStatus();

  // FUNCIÓN 1: Cargar datos personales
  function loadProfileData() {
    console.log('📋 Cargando datos personales...');
    
    fetch('../../php/api/completar-perfil.php', { 
      credentials: 'include',
      headers: { 'Cache-Control': 'no-cache' }
    })
    .then(res => {
      console.log('📡 Respuesta perfil:', res.status);
      return res.json();
    })
    .then(data => {
      console.log('📦 Datos perfil:', data);
      
      if (data.success && data.data) {
        profileData = data.data;
        
        fields.forEach(f => {
          const span = document.getElementById(f + '_span');
          if (span) {
            let value = 'No definit';
            
            if (f === 'fullname') {
              value = data.data.fullname || data.data.username || 'No definit';
            } else if (data.data[f]) {
              value = data.data[f];
            }
            
            span.textContent = value;
            console.log('✓', f, '=', value);
          } else {
            console.error('❌ No se encontró elemento:', f + '_span');
          }
        });
      } else {
        console.error('❌ Error en respuesta:', data);
        fields.forEach(f => {
          const span = document.getElementById(f + '_span');
          if (span) span.textContent = 'Error';
        });
      }
    })
    .catch(err => {
      console.error('❌ Error:', err);
      fields.forEach(f => {
        const span = document.getElementById(f + '_span');
        if (span) span.textContent = 'Error';
      });
    });
  }

  // FUNCIÓN 2: Cargar puntos
  function loadPoints() {
    console.log('💰 Cargando puntos...');
    
    fetch('../../php/api/get-points.php', { 
      credentials: 'include',
      headers: { 'Cache-Control': 'no-cache' }
    })
    .then(res => {
      console.log('📡 Respuesta puntos:', res.status);
      return res.json();
    })
    .then(data => {
      console.log('📦 Datos puntos:', data);
      
      if (data.success) {
        const userPointsEl = document.getElementById('userPoints');
        const timeAvailableEl = document.getElementById('timeAvailable');
        
        if (userPointsEl) {
          userPointsEl.textContent = data.points.toLocaleString('ca-ES');
          console.log('✓ Puntos:', data.points);
        }
        
        if (timeAvailableEl) {
          const minutes = data.minutes_available || 0;
          const hours = Math.floor(minutes / 60);
          const mins = minutes % 60;
          timeAvailableEl.textContent = hours + 'h ' + mins + 'min';
          console.log('✓ Tiempo:', hours + 'h ' + mins + 'min');
        }
      } else {
        console.error('❌ Error en respuesta puntos:', data);
        document.getElementById('userPoints').textContent = '0';
        document.getElementById('timeAvailable').textContent = '0h 0min';
      }
    })
    .catch(err => {
      console.error('❌ Error puntos:', err);
      document.getElementById('userPoints').textContent = '0';
      document.getElementById('timeAvailable').textContent = '0h 0min';
    });
  }

  // FUNCIÓN 3: Cargar estado premium
  function loadPremiumStatus() {
    console.log('⭐ Verificando premium...');
    
    fetch('../../php/api/get-points.php', { 
      credentials: 'include',
      headers: { 'Cache-Control': 'no-cache' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success && data.is_premium) {
        console.log('✓ Usuario Premium detectado');
        const statusDiv = document.getElementById('premiumStatus');
        if (statusDiv) {
          const expiresDate = new Date(data.premium_expires_at);
          const now = new Date();
          const daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));
          
          statusDiv.innerHTML = '<div class="card-glass" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 193, 7, 0.2) 100%); border: 2px solid rgba(255, 215, 0, 0.6); padding: var(--spacing-lg);"><div style="display: flex; align-items: center; gap: var(--spacing-md);"><div style="font-size: 2rem;">⭐</div><div style="flex: 1;"><h4 style="margin: 0 0 var(--spacing-xs) 0; color: #FFD700;">Premium Actiu</h4><p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">Expira: ' + expiresDate.toLocaleDateString('ca-ES') + ' (' + daysLeft + ' dies)</p></div></div></div>';
          statusDiv.style.display = 'block';
        }
        loadDailyBonusStatus();
      }
    })
    .catch(err => console.error('Error premium:', err));
  }

  // FUNCIÓN 4: Bonus diario
  function loadDailyBonusStatus() {
    fetch('../../php/api/check-daily-bonus.php', { credentials: 'include' })
      .then(res => res.json())
      .then(data => {
        if (data.success && data.is_premium) {
          const bonusDiv = document.getElementById('dailyBonusSection');
          if (bonusDiv && data.can_claim) {
            bonusDiv.innerHTML = '<div class="card-glass" style="background: linear-gradient(135deg, rgba(166, 238, 54, 0.2) 0%, rgba(105, 183, 240, 0.2) 100%); border: 2px solid rgba(166, 238, 54, 0.6); padding: var(--spacing-lg);"><div style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-md);"><div style="display: flex; align-items: center; gap: var(--spacing-md);"><div style="font-size: 2rem;">🎁</div><div><h4 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-accent-primary);">Bonus Diari Disponible!</h4><p style="margin: 0; font-size: 0.875rem; color: var(--color-text-secondary);">Reclama 200 punts gratuïts</p></div></div><button onclick="claimDailyBonus()" class="btn btn-primary" style="min-width: 150px;">Reclamar</button></div></div>';
            bonusDiv.style.display = 'block';
          }
        }
      })
      .catch(err => console.error('Error bonus:', err));
  }

  window.claimDailyBonus = function() {
    fetch('../../php/api/claim-daily-bonus.php', { 
      method: 'POST', 
      credentials: 'include' 
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('¡Bonus reclamado! +200 puntos');
        loadPoints();
        loadDailyBonusStatus();
      } else {
        alert(data.message || 'Error');
      }
    });
  };

  console.log('✅ Script perfil inicializado');
  
  // Inicializar dropdown de perfil
  initProfileDropdown();
  
  // Cargar nombre de usuario
  loadUsername();
});

// Función para inicializar dropdown de perfil
function initProfileDropdown() {
  const profileBtn = document.getElementById('profileDropdown');
  const profileMenu = document.getElementById('profileMenu');
  const langMenu = document.getElementById('langMenu');
  
  if (profileBtn && profileMenu) {
    profileBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      profileMenu.style.display = profileMenu.style.display === 'none' ? 'block' : 'none';
      
      // Cerrar menú de idiomas si está abierto
      if (langMenu) langMenu.style.display = 'none';
    });
  }
  
  console.log('✅ Dropdown de perfil inicializado');
}

// Función para cargar nombre de usuario
function loadUsername() {
  fetch('../../php/api/session-check.php', { 
    credentials: 'include' 
  })
  .then(res => res.json())
  .then(data => {
    if (data.loggedIn && data.username) {
      const usernameEl = document.getElementById('profileUsername');
      const avatarEl = document.getElementById('profileAvatar');
      
      if (usernameEl) {
        usernameEl.textContent = data.username;
      }
      
      if (avatarEl) {
        avatarEl.textContent = data.username.charAt(0).toUpperCase();
      }
      
      console.log('✅ Usuario cargado:', data.username);
    }
  })
  .catch(err => console.error('Error cargando usuario:', err));
}

// Función para cerrar sesión
function logout() {
  if (confirm('Estàs segur que vols tancar la sessió?')) {
    fetch('../../php/api/logout.php', { 
      method: 'POST',
      credentials: 'include' 
    })
    .then(() => {
      showToast('Sessió tancada correctament', 'success');
      setTimeout(() => {
        window.location.href = '../auth/login.html';
      }, 1000);
    })
    .catch(err => {
      console.error('Error al cerrar sesión:', err);
      window.location.href = '../auth/login.html';
    });
  }
}
    </script>
</body>
</html>
