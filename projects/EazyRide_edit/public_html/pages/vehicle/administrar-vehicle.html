<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzyRide - Control Vehicle</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/administrar-vehicle.css">
    <script src="../../js/toast.js?v=1761166892"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="">
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="../../images/logo.png" alt="Logo EzyRide">
            <h1>EzyRide</h1>
        </div>
        <div class="header-center"><h1 class="page-title">Administrar Vehicle</h1></div><div class="user-info" style="display: flex; gap: var(--spacing-md); align-items: center;">
            <button id="release-vehicle-btn" class="btn btn-ghost" style="color: var(--color-error);">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                Finalitzar
            </button>
            <a href="../dashboard/gestio.html" class="btn btn-ghost">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Gestió
            </a>
        </div>
    </header>

    <main>
        <!-- Loading State -->
        <div id="loading-state" class="container fade-in" style="text-align: center;">
            <div class="spinner" style="margin: 0 auto var(--spacing-lg);"></div>
            <p style="color: var(--color-text-secondary);">Carregant informació del vehicle...</p>
        </div>

        <!-- No Vehicle State -->
        <div id="no-vehicle-state" class="container fade-in" style="display: none; text-align: center;">
            <div style="width: 100px; height: 100px; margin: 0 auto var(--spacing-xl); background: linear-gradient(135deg, var(--color-accent-secondary) 0%, var(--color-accent-purple) 100%); border-radius: var(--radius-xl); display: flex; align-items: center; justify-content: center;">
                <svg width="50" height="50" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
            </div>
            <h2 style="margin-bottom: var(--spacing-md);">No tens cap vehicle reservat</h2>
            <p style="color: var(--color-text-secondary); margin-bottom: var(--spacing-xl);">
                Necessites reservar un vehicle per poder accedir a aquesta pàgina
            </p>
            <a href="localitzar-vehicle.html" class="btn btn-primary">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                Buscar Vehicles
            </a>
        </div>

        <!-- Vehicle Control State -->
        <div id="vehicle-control-state" class="container container-large fade-in" style="display: none;">
            <!-- Título -->
            <div style="text-align: center; margin-bottom: var(--spacing-xl);">
                <p id="vehicle-name" style="color: var(--color-text-secondary); font-size: 1.125rem; font-weight: 600;">
                    <!-- Vehicle name will be loaded here -->
                </p>
            </div>

            <!-- Estado y Batería -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-xl);">
                <!-- Estado -->
                <div class="card-glass" style="text-align: center;">
                    <div style="width: 50px; height: 50px; margin: 0 auto var(--spacing-sm); background: linear-gradient(135deg, var(--color-accent-primary) 0%, #34C759 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                        <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Estat</p>
                    <p id="vehicle-status" style="font-size: 1.125rem; font-weight: 600; color: var(--color-accent-primary);">Carregant...</p>
                </div>

                <!-- Batería -->
                <div class="card-glass" style="text-align: center;">
                    <div style="width: 50px; height: 50px; margin: 0 auto var(--spacing-sm); background: linear-gradient(135deg, var(--color-accent-secondary) 0%, var(--color-accent-blue) 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                        <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                            <rect x="1" y="6" width="18" height="12" rx="2" ry="2"/>
                            <line x1="23" y1="13" x2="23" y2="11"/>
                        </svg>
                    </div>
                    <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Bateria</p>
                    <p id="battery-level" style="font-size: 1.125rem; font-weight: 600; color: var(--color-accent-secondary);">--%</p>
                </div>

                <!-- Velocitat -->
                <div class="card-glass" style="text-align: center;">
                    <div style="width: 50px; height: 50px; margin: 0 auto var(--spacing-sm); background: linear-gradient(135deg, var(--color-accent-purple) 0%, #FF6B9D 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                        <svg width="24" height="24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                    <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Velocitat</p>
                    <p id="speed" style="font-size: 1.125rem; font-weight: 600; color: var(--color-accent-purple);">0 km/h</p>
                </div>
            </div>

            <!-- Mapa -->
            <div class="card-glass" style="margin-bottom: var(--spacing-xl);">
                <h3 style="margin-bottom: var(--spacing-md); font-size: 1.125rem;">Ubicació del Vehicle</h3>
                <div id="map" style="height: 350px; border-radius: var(--radius-md); overflow: hidden; position: relative;"></div>
            </div>

            <!-- Controles -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-xl);">
                <!-- Bloquear/Desblocar -->
                <button id="lock-btn" class="pushable">
                    <span class="shadow"></span>
                    <span class="edge"></span>
                    <span class="front" style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        <span id="lock-text">Bloquejar</span>
                    </span>
                </button>

                <!-- Llums -->
                <button id="lights-btn" class="pushable yellow">
                    <span class="shadow"></span>
                    <span class="edge"></span>
                    <span class="front" style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                        <span>Llums</span>
                    </span>
                </button>

                <!-- Claxon -->
                <button id="horn-btn" class="pushable red">
                    <span class="shadow"></span>
                    <span class="edge"></span>
                    <span class="front" style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                        <span>Claxon</span>
                    </span>
                </button>

                <!-- Actualitzar -->
                <button id="refresh-btn" class="pushable green">
                    <span class="shadow"></span>
                    <span class="edge"></span>
                    <span class="front" style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                            <polyline points="23 4 23 10 17 10"/>
                            <polyline points="1 20 1 14 7 14"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                        <span>Actualitzar</span>
                    </span>
                </button>
            </div>

            <!-- Botón Finalizar Reserva -->
            <button id="release-vehicle-main" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                </svg>
                Finalitzar Reserva
            </button>
        </div>
    </main>

    <footer>
        <p>© 2025 EzyRide. Tots els drets reservats.</p>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        let map;
        let marker;
        let vehicleData = null;
        let vehicleId = null;
        let isLocked = false;

        // Cargar datos del vehículo del usuario
        async function loadVehicleData() {
            try {
                console.log('🔄 Carregant dades del vehicle...');
                
                const response = await fetch('../../php/api/get-user-vehicle.php', {
                    method: 'GET',
                    credentials: 'include'
                });

                console.log('📡 Response status:', response.status);
                
                const data = await response.json();
                console.log('📦 Data received:', data);

                if (data.success && data.vehicle) {
                    console.log('✅ Vehicle trobat:', data.vehicle);
                    vehicleData = data.vehicle;
                    vehicleId = data.vehicle.vehicle_id;
                    showVehicleControl();
                    updateVehicleInfo();
                    initMap();
                } else {
                    console.log('❌ No vehicle found:', data.message);
                    if (data.debug) {
                        console.log('🔍 Debug info:', data.debug);
                    }
                    showToast(data.message || 'No tens cap vehicle reservat', 'info');
                    showNoVehicleState();
                }
            } catch (error) {
                console.error('💥 Error loading vehicle data:', error);
                showToast('Error al carregar les dades del vehicle', 'error');
                showNoVehicleState();
            }
        }

        function showVehicleControl() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('no-vehicle-state').style.display = 'none';
            document.getElementById('vehicle-control-state').style.display = 'block';
        }

        function showNoVehicleState() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('vehicle-control-state').style.display = 'none';
            document.getElementById('no-vehicle-state').style.display = 'block';
            
            setTimeout(() => {
                window.location.href = 'localitzar-vehicle.html';
            }, 3000);
        }

        function updateVehicleInfo() {
            if (!vehicleData) return;

            document.getElementById('vehicle-name').textContent = vehicleData.model || 'Vehicle';

            const status = vehicleData.status || 'available';
            const statusText = status === 'available' ? 'Operatiu' : status === 'in_use' ? 'En ús' : 'Manteniment';
            document.getElementById('vehicle-status').textContent = statusText;

            const battery = vehicleData.battery_level || 0;
            document.getElementById('battery-level').textContent = battery + '%';

            const speed = vehicleData.speed || 0;
            document.getElementById('speed').textContent = speed + ' km/h';

            const batteryElement = document.getElementById('battery-level');
            if (battery >= 80) {
                batteryElement.style.color = 'var(--color-accent-primary)';
            } else if (battery >= 50) {
                batteryElement.style.color = '#FFD60A';
            } else {
                batteryElement.style.color = 'var(--color-error)';
            }
        }

        function initMap() {
            if (!vehicleData) return;

            const lat = parseFloat(vehicleData.latitude) || 41.3851;
            const lng = parseFloat(vehicleData.longitude) || 2.1734;
            const coords = [lat, lng];

            map = L.map('map').setView(coords, 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker(coords).addTo(map)
                .bindPopup(`
                    <div style="text-align: center;">
                        <strong>${vehicleData.model || 'Vehicle'}</strong><br>
                        <span style="color: var(--color-accent-primary);">🔋 ${vehicleData.battery_level || 0}%</span>
                    </div>
                `)
                .openPopup();
        }

        // Control de bloqueo - API call
        document.getElementById('lock-btn')?.addEventListener('click', async function() {
            const action = isLocked ? 'unlock' : 'lock';
            
            try {
                const response = await fetch('../../php/api/vehicle-control.php', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vehicle_id: vehicleId,
                        action: action
                    })
                });

                const data = await response.json();

                if (data.success) {
                    isLocked = !isLocked;
                    document.getElementById('lock-text').textContent = isLocked ? 'Desbloquejar' : 'Bloquejar';
                    showToast(`Vehicle ${isLocked ? 'bloquejat' : 'desbloquejat'}`, 'success');
                } else {
                    showToast(data.message || 'Error en el control', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de connexió', 'error');
            }
        });

        // Llums - API call
        document.getElementById('lights-btn')?.addEventListener('click', async function() {
            try {
                const response = await fetch('../../php/api/vehicle-control.php', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vehicle_id: vehicleId,
                        action: 'toggle_lights'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Llums activats', 'success');
                } else {
                    showToast(data.message || 'Error en el control', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de connexió', 'error');
            }
        });

        // Claxon - API call
        document.getElementById('horn-btn')?.addEventListener('click', async function() {
            try {
                const response = await fetch('../../php/api/vehicle-control.php', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vehicle_id: vehicleId,
                        action: 'horn'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Claxon activat', 'success');
                } else {
                    showToast(data.message || 'Error en el control', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de connexió', 'error');
            }
        });

        // Actualitzar
        document.getElementById('refresh-btn')?.addEventListener('click', function() {
            showToast('Actualitzant dades...', 'info');
            loadVehicleData();
        });

        // Finalizar reserva
        const releaseButtons = document.querySelectorAll('#release-vehicle-btn, #release-vehicle-main');
        releaseButtons.forEach(btn => {
            btn.addEventListener('click', async function() {
                if (confirm('Segur que vols finalitzar la reserva?')) {
                    try {
                        const response = await fetch('../../php/api/release-vehicle.php', {
                            method: 'POST',
                            credentials: 'include',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        const data = await response.json();

                        if (data.success) {
                            showToast('Reserva finalitzada', 'success');
                            setTimeout(() => {
                                window.location.href = '../dashboard/gestio.html';
                            }, 1500);
                        } else {
                            showToast(data.message || 'Error al finalitzar la reserva', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showToast('Error de connexió', 'error');
                    }
                }
            });
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadVehicleData();
        });
    </script>
</body>
</html>
