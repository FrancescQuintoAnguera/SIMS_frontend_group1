<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzyRide - EazyPoints</title>
    <link rel="stylesheet" href="../../css/main.css">
    <script src="../../js/translations.js" defer></script>
    <script src="../../js/toast.js?v=1761166892" defer></script>
</head>
<body data-no-auto-layout>
    <header>
        <div class="logo-container">
            <a href="../dashboard/gestio.html" style="display: flex; align-items: center; gap: var(--spacing-md); text-decoration: none;">
                <img src="../../images/logo.png" alt="Logo EzyRide" style="height: 40px; width: 40px; border-radius: var(--radius-md);">
                <h1 style="margin: 0; font-size: 1.5rem; font-weight: 700;">EzyRide</h1>
            </a>
        </div>
        <div class="header-center"><h1 class="page-title">Comprar Temps</h1></div><div class="user-info" style="display: flex; align-items: center; gap: var(--spacing-md);">
            <!-- Selector de idioma -->
            <div class="language-selector" style="position: relative;">
                <button id="langBtn" class="btn btn-ghost" style="padding: var(--spacing-sm) var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-xs);">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    <span id="currentLangText">CA</span>
                </button>
                <div id="langMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 150px; padding: var(--spacing-xs); display: none; z-index: 1000;">
                    <button onclick="changeLanguage('ca')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇪🇸 Català
                    </button>
                    <button onclick="changeLanguage('es')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇪🇸 Español
                    </button>
                    <button onclick="changeLanguage('en')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇬🇧 English
                    </button>
                </div>
            </div>
            
            <!-- Dropdown de perfil -->
            <div style="position: relative;">
                <button id="profileDropdown" class="btn btn-ghost" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <div id="profileAvatar" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.875rem;">
                        ...
                    </div>
                    <span id="profileUsername">Cargando...</span>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div id="profileMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 220px; padding: var(--spacing-xs); display: none; z-index: 1000;">
                    <a href="../profile/perfil.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span>El meu perfil</span>
                    </a>
                    <a href="../vehicle/purchase-time.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Comprar Punts</span>
                    </a>
                    <a href="../profile/premium.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                        <span>Premium</span>
                    </a>
                    <hr style="margin: var(--spacing-sm) 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button onclick="logout()" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md); color: #EF4444;">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Tancar sessió</span>
                    </button>
                </div>
            </div>
            
            <a href="../dashboard/gestio.html" class="btn btn-ghost">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span data-i18n="management">Gestió</span>
            </a>
        </div>
    </header>

    <main>
        <div class="container container-large fade-in">
            <!-- Título -->
            <div style="text-align: center; margin-bottom: var(--spacing-2xl);">
                <div class="icon-container icon-container-lg" style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, #FFD700 100%);">
                    <svg width="50" height="50" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="19" cy="12" r="1"/>
                        <circle cx="5" cy="12" r="1"/>
                        <circle cx="12" cy="5" r="1"/>
                        <circle cx="12" cy="19" r="1"/>
                    </svg>
                </div>
                <p style="color: var(--color-text-secondary); margin-top: var(--spacing-md);">Compra punts i gaudeix dels teus viatges</p>
            </div>

            <!-- Saldo actual -->
            <div class="card-glass" style="margin-bottom: var(--spacing-xl); padding: var(--spacing-xl); text-align: center;">
                <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">El teu saldo actual</p>
                <p style="font-size: 3rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent-primary) 0%, #FFD700 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">
                    <span id="currentPoints">0</span>
                    <span style="font-size: 1.5rem;">pts</span>
                </p>
            </div>

            <!-- Premium Banner -->
            <div id="premiumBannerContainer" style="margin-bottom: var(--spacing-2xl);">
                <!-- Banner cuando NO tiene premium -->
                <a id="noPremiumBanner" href="../profile/premium.html" class="card-glass" style="display: block; padding: var(--spacing-xl); text-decoration: none; background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 193, 7, 0.15) 100%); border: 2px solid rgba(255, 215, 0, 0.4);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-lg);">
                        <div class="icon-container" style="background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%); flex-shrink: 0;">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <p style="font-size: 1.25rem; font-weight: 700; margin: 0 0 var(--spacing-xs) 0;">Sigues Premium</p>
                            <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">15% de descompte en tots els paquets + 15 min gratuïts diaris</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="font-size: 1.5rem; font-weight: 700; color: #FFD700; margin: 0;">4,99€</p>
                            <p style="font-size: 0.75rem; color: var(--color-text-secondary); margin: 0;">/mes</p>
                        </div>
                    </div>
                </a>
                
                <!-- Banner cuando SÍ tiene premium -->
                <div id="hasPremiumBanner" class="card-glass" style="display: none; padding: var(--spacing-xl); background: linear-gradient(135deg, rgba(166, 238, 54, 0.2) 0%, rgba(105, 183, 240, 0.2) 100%); border: 2px solid rgba(166, 238, 54, 0.6);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-lg);">
                        <div class="icon-container" style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); flex-shrink: 0;">
                            <svg width="30" height="30" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <p style="font-size: 1.25rem; font-weight: 700; margin: 0 0 var(--spacing-xs) 0; color: var(--color-accent-primary);">✨ Ets Premium!</p>
                            <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: 0;">
                                Gaudint de 15% de descompte + 15 min diaris gratis
                                <span id="premiumExpiresText" style="display: block; margin-top: 4px; font-size: 0.75rem; opacity: 0.8;"></span>
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <p style="font-size: 1.125rem; font-weight: 700; color: var(--color-accent-primary); margin: 0;">✓ ACTIU</p>
                            <p style="font-size: 0.75rem; color: var(--color-text-secondary); margin: 0;">Subscripció activa</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Alert -->
            <div class="card-glass" style="background: rgba(105, 183, 240, 0.1); border: 1px solid rgba(105, 183, 240, 0.3); padding: var(--spacing-md); margin-bottom: var(--spacing-xl); display: flex; align-items: center; gap: var(--spacing-md);">
                <svg width="24" height="24" fill="none" stroke="var(--color-accent-secondary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <div style="flex: 1;">
                    <p style="font-size: 0.875rem; margin: 0;"><strong>Cost del lloguer:</strong></p>
                    <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: var(--spacing-xs) 0 0 0;">
                        • 30 min = 400 pts (~7,5€) | 1h = 800 pts | 2h = 1.600 pts<br>
                        • A partir de 2h: +1.000 pts/hora addicional
                    </p>
                </div>
            </div>

            <!-- Paquets de Punts -->
            <div class="section">
                <h3 class="section-title">Paquets d'EazyPoints</h3>
                <div class="grid grid-auto" style="gap: var(--spacing-lg);">
                    
                    <!-- Paquet Bàsic -->
                    <div onclick="openModal(event)" data-points="400" data-price="3.99" data-discount="15" data-name="Bàsic" class="card-glass" style="cursor: pointer; padding: var(--spacing-lg); position: relative;">
                        <span class="badge badge-success" style="position: absolute; top: var(--spacing-md); right: var(--spacing-md);">-15%</span>
                        <div style="text-align: center; margin-bottom: var(--spacing-md);">
                            <div style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #8B949E 0%, #6E7681 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                400
                            </div>
                            <p style="font-size: 0.75rem; color: var(--color-text-secondary); margin: 0;">punts</p>
                        </div>
                        <div class="divider"></div>
                        <div style="text-align: center;">
                            <p style="font-size: 1.875rem; font-weight: 700; color: var(--color-accent-primary); margin: 0;" data-price-display><span data-original-price>3,99€</span></p>
                            <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-top: var(--spacing-xs);">~30 min de lloguer</p>
                        </div>
                    </div>

                    <!-- Paquet Estàndard -->
                    <div onclick="openModal(event)" data-points="1000" data-price="7.99" data-discount="18" data-name="Estàndard" class="card-glass" style="cursor: pointer; padding: var(--spacing-lg); position: relative; border: 2px solid var(--color-accent-secondary);">
                        <span class="badge badge-success" style="position: absolute; top: var(--spacing-md); right: var(--spacing-md);">-18%</span>
                        <div style="text-align: center; margin-bottom: var(--spacing-md);">
                            <div style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent-secondary) 0%, var(--color-accent-blue) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                1.000
                            </div>
                            <p style="font-size: 0.75rem; color: var(--color-text-secondary); margin: 0;">punts</p>
                        </div>
                        <div class="divider"></div>
                        <div style="text-align: center;">
                            <p style="font-size: 1.875rem; font-weight: 700; color: var(--color-accent-primary); margin: 0;" data-price-display><span data-original-price>7,99€</span></p>
                            <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-top: var(--spacing-xs);">~1h 15min de lloguer</p>
                        </div>
                    </div>

                    <!-- Paquet Plus -->
                    <div onclick="openModal(event)" data-points="2000" data-price="14.99" data-discount="25" data-name="Plus" class="card-glass" style="cursor: pointer; padding: var(--spacing-lg); position: relative; border: 2px solid var(--color-accent-primary);">
                        <span class="badge badge-success" style="position: absolute; top: var(--spacing-md); right: var(--spacing-md);">-25%</span>
                        <div style="text-align: center; margin-bottom: var(--spacing-md);">
                            <div style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent-primary) 0%, #00C853 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                2.000
                            </div>
                            <p style="font-size: 0.75rem; color: var(--color-text-secondary); margin: 0;">punts</p>
                        </div>
                        <div class="divider"></div>
                        <div style="text-align: center;">
                            <p style="font-size: 1.875rem; font-weight: 700; color: var(--color-accent-primary); margin: 0;" data-price-display><span data-original-price>14,99€</span></p>
                            <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-top: var(--spacing-xs);">~2h 30min de lloguer</p>
                        </div>
                    </div>

                    <!-- Paquet Extra -->
                    <div onclick="openModal(event)" data-points="5000" data-price="29.99" data-discount="30" data-name="Extra" class="card-glass" style="cursor: pointer; padding: var(--spacing-lg); position: relative; border: 2px solid #FFD700; background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 193, 7, 0.05) 100%);">
                        <span class="badge badge-warning" style="position: absolute; top: var(--spacing-md); right: var(--spacing-md);">-30% + BONUS</span>
                        <div style="text-align: center; margin-bottom: var(--spacing-md);">
                            <div style="font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, #FFD700 0%, #FFC107 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                5.000
                            </div>
                            <p style="font-size: 0.75rem; color: var(--color-text-secondary); margin: 0;">punts + bonus</p>
                        </div>
                        <div class="divider"></div>
                        <div style="text-align: center;">
                            <p style="font-size: 1.875rem; font-weight: 700; color: #FFD700; margin: 0;" data-price-display><span data-original-price>29,99€</span></p>
                            <p style="font-size: 0.75rem; color: var(--color-text-tertiary); margin-top: var(--spacing-xs);">~6h 15min de lloguer</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal -->
        <div id="purchaseModal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; z-index: 1000;">
            <div class="container" style="max-width: 450px;">
                <h3 style="margin-bottom: var(--spacing-lg); text-align: center;">Confirmar compra</h3>
                <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                    <p style="font-size: 3rem; font-weight: 700; background: linear-gradient(135deg, var(--color-accent-primary) 0%, #FFD700 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;" id="modalPoints">0</p>
                    <p style="font-size: 0.875rem; color: var(--color-text-secondary); margin: var(--spacing-xs) 0 0 0;">EazyPoints</p>
                </div>
                <p style="color: var(--color-text-secondary); text-align: center; margin-bottom: var(--spacing-xs);">Paquet: <strong id="modalPackage"></strong></p>
                <p style="color: var(--color-text-secondary); text-align: center; margin-bottom: var(--spacing-xl);">
                    Descompte: <span class="badge badge-success" id="modalDiscount"></span>
                </p>
                <p style="font-size: 2rem; font-weight: 700; text-align: center; color: var(--color-accent-primary); margin-bottom: var(--spacing-xl);" id="modalPrice">0€</p>
                <div style="display: flex; gap: var(--spacing-md);">
                    <button onclick="closeModal()" class="btn btn-secondary" style="flex: 1;">Cancel·lar</button>
                    <button onclick="confirmPurchase()" class="btn btn-primary" style="flex: 1;">Confirmar</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p data-i18n="rights">© 2025 EzyRide. Tots els drets reservats.</p>
    </footer>

<script>
    // Variables globales - Declaradas al inicio
    let pointsSelected = 0;
    let priceSelected = 0;
    let packageName = '';
    let discount = 0;
    let isPremium = false;
    let currentLang = 'ca'; // Inicializar idioma por defecto
    let originalPrices = {
        400: { price: 3.99, discount: 15 },
        1000: { price: 7.99, discount: 18 },
        2000: { price: 14.99, discount: 25 },
        5000: { price: 29.99, discount: 30 }
    };

    // Esperar a que el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar perfil de usuario
        loadUserProfile();
        
        // Inicializar dropdowns
        const profileDropdown = document.getElementById('profileDropdown');
        const profileMenu = document.getElementById('profileMenu');
        const langBtn = document.getElementById('langBtn');
        const langMenu = document.getElementById('langMenu');
        const currentLangText = document.getElementById('currentLangText');
        
        if (profileDropdown && profileMenu) {
            profileDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
                profileMenu.style.display = profileMenu.style.display === 'none' ? 'block' : 'none';
                if (langMenu) langMenu.style.display = 'none';
            });
        }
        
        if (langBtn && langMenu) {
            langBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                langMenu.style.display = langMenu.style.display === 'none' ? 'block' : 'none';
                if (profileMenu) profileMenu.style.display = 'none';
            });
        }

        document.addEventListener('click', () => {
            if (langMenu) langMenu.style.display = 'none';
            if (profileMenu) profileMenu.style.display = 'none';
        });

        // Actualizar texto de idioma actual (con fallback si translations.js no está cargado)
        if (currentLangText) {
            const lang = (typeof currentLang !== 'undefined') ? currentLang.toUpperCase() : 'CA';
            currentLangText.textContent = lang;
        }
        
        // Cargar saldo actual
        loadCurrentPoints();
    });

    // Cargar perfil de usuario
    async function loadUserProfile() {
        try {
            const response = await fetch('../../php/user/user-profile.php', {
                credentials: 'include'
            });
            
            if (!response.ok) throw new Error('Network error');
            
            const data = await response.json();
            
            if (data.success && data.data) {
                const username = data.data.username || 'Usuario';
                const usernameEl = document.getElementById('profileUsername');
                if (usernameEl) usernameEl.textContent = username;
                
                // Avatar con iniciales
                const initial = username.charAt(0).toUpperCase();
                const avatarEl = document.getElementById('profileAvatar');
                if (avatarEl) avatarEl.textContent = initial;
            }
        } catch (error) {
            console.error('Error loading user profile:', error);
        }
    }
    
    // Función de logout
    function logout() {
        fetch('../../php/auth/logout.php', {
            method: 'POST',
            credentials: 'include'
        })
        .then(() => {
            window.location.href = '../auth/login.html';
        })
        .catch(error => {
            console.error('Error al cerrar sesión:', error);
            window.location.href = '../auth/login.html';
        });
    }

    function loadCurrentPoints() {
        const pointsElement = document.getElementById('currentPoints');
        
        // Mostrar indicador de carga
        if (pointsElement) {
            pointsElement.style.opacity = '0.5';
        }
        
        fetch('../../php/api/get-points.php', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Cache-Control': 'no-cache'
            }
        })
        .then(res => {
            if (!res.ok) {
                throw new Error('HTTP error ' + res.status);
            }
            return res.json();
        })
        .then(data => {
            console.log('Puntos recibidos:', data); // Debug
            
            if (data.success) {
                const currentPoints = data.points || 0;
                
                // Actualizar con animación
                if (pointsElement) {
                    pointsElement.style.opacity = '1';
                    pointsElement.textContent = currentPoints.toLocaleString('ca-ES');
                }
                
                isPremium = data.is_premium || false;
                
                // Si es premium, actualizar todos los precios y mostrar banner
                if (isPremium) {
                    applyPremiumDiscounts();
                    showPremiumBadge(data);
                }
                
                console.log('Saldo actualizado a:', currentPoints); // Debug
            } else {
                console.error('Error en respuesta:', data.message);
                
                // Si el error es de autenticación, mostrar mensaje pero NO redirigir automáticamente
                if (data.message && data.message.includes('autoritzat')) {
                    if (pointsElement) {
                        pointsElement.style.opacity = '1';
                        pointsElement.textContent = '--';
                    }
                    
                    // Mostrar mensaje de advertencia
                    const t = (typeof window.t === 'function') ? window.t : (key) => key;
                    if (typeof showToast === 'function') {
                        showToast('Per comprar punts, si us plau inicia sessió', 'warning', 5000);
                        
                        // Dar tiempo al usuario para ver el mensaje antes de redirigir
                        setTimeout(() => {
                            window.location.href = '../auth/login.html';
                        }, 2000);
                    }
                } else {
                    if (pointsElement) {
                        pointsElement.style.opacity = '1';
                        pointsElement.textContent = '0';
                    }
                }
            }
        })
        .catch(err => {
            console.error('Error loading points:', err);
            if (pointsElement) {
                pointsElement.style.opacity = '1';
                pointsElement.textContent = '0';
            }
        });
    }

    function applyPremiumDiscounts() {
        // Aplicar 15% de descuento adicional a todos los paquetes
        document.querySelectorAll('[data-points]').forEach(card => {
            const points = parseInt(card.dataset.points);
            const original = originalPrices[points];
            
            if (original) {
                // Precio con 15% descuento adicional
                const premiumPrice = (original.price * 0.85).toFixed(2);
                const totalDiscount = original.discount + 15;
                
                // Actualizar datos del card
                card.dataset.price = premiumPrice;
                card.dataset.discount = totalDiscount;
                
                // Actualizar badge
                const badge = card.querySelector('.badge');
                if (badge) {
                    badge.textContent = '-' + totalDiscount + '%';
                    badge.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                }
                
                // Actualizar precio mostrado
                const priceElement = card.querySelector('[data-price-display]');
                if (priceElement) {
                    const originalPriceEl = card.querySelector('[data-original-price]');
                    if (originalPriceEl) {
                        originalPriceEl.style.textDecoration = 'line-through';
                        originalPriceEl.style.opacity = '0.5';
                    }
                    priceElement.innerHTML = `<span style="color: #FFD700; font-weight: 700;">${premiumPrice}€</span> <span style="text-decoration: line-through; opacity: 0.5; font-size: 0.9rem;">${original.price.toFixed(2)}€</span>`;
                }
            }
        });
    }

    function showPremiumBadge(premiumData) {
        const noPremiumBanner = document.getElementById('noPremiumBanner');
        const hasPremiumBanner = document.getElementById('hasPremiumBanner');
        const premiumExpiresText = document.getElementById('premiumExpiresText');
        
        if (noPremiumBanner && hasPremiumBanner) {
            // Ocultar banner de "Sigues Premium"
            noPremiumBanner.style.display = 'none';
            
            // Mostrar banner de "Ets Premium"
            hasPremiumBanner.style.display = 'block';
            
            // Mostrar fecha de expiración si existe
            if (premiumData && premiumData.premium_expires_at) {
                const expiresDate = new Date(premiumData.premium_expires_at);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = expiresDate.toLocaleDateString('ca-ES', options);
                premiumExpiresText.textContent = `Vàlid fins: ${formattedDate}`;
            }
            
            console.log('✅ Banner Premium actiu mostrat');
        }
    }

    function openModal(e) {
        const target = e.currentTarget;
        pointsSelected = parseInt(target.dataset.points);
        priceSelected = parseFloat(target.dataset.price);
        packageName = target.dataset.name;
        discount = parseInt(target.dataset.discount);

        document.getElementById('modalPoints').textContent = pointsSelected.toLocaleString('ca-ES');
        document.getElementById('modalPackage').textContent = packageName;
        
        // Mostrar descuento (incluyendo premium si aplica)
        const discountText = isPremium ? 
            `-${discount}% (Base ${discount - 15}% + Premium 15%)` : 
            `-${discount}%`;
        document.getElementById('modalDiscount').textContent = discountText;
        
        document.getElementById('modalPrice').textContent = priceSelected.toFixed(2) + '€';

        const modal = document.getElementById('purchaseModal');
        modal.style.display = 'flex';
    }

    function closeModal() {
        const modal = document.getElementById('purchaseModal');
        modal.style.display = 'none';
    }

    function confirmPurchase() {
        const confirmBtn = document.querySelector('#purchaseModal .btn-primary');
        const originalText = confirmBtn.innerHTML;
        
        // Deshabilitar botón y mostrar loading
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span style="display: inline-block; width: 20px; height: 20px; border: 3px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span> Processant...';
        
        fetch('../../php/api/purchase-points.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                points: pointsSelected,
                price: priceSelected,
                package: packageName,
                discount: discount
            })
        })
        .then(res => {
            if (!res.ok) {
                throw new Error('HTTP error ' + res.status);
            }
            return res.json();
        })
        .then(data => {
            console.log('Respuesta de compra:', data); // Debug
            
            if (data.success) {
                // Cerrar modal
                closeModal();
                
                // Mostrar toast de éxito con el nuevo saldo
                const newBalance = data.new_balance || (data.points_added + parseInt(document.getElementById('currentPoints').textContent.replace(/\./g, '')));
                showToast(
                    `¡Compra realitzada! +${data.points_added} punts. Nou saldo: ${newBalance.toLocaleString('ca-ES')} pts`,
                    'success',
                    4000
                );
                
                // Actualizar saldo inmediatamente
                setTimeout(() => {
                    loadCurrentPoints();
                }, 500);
                
                // Restaurar botón
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
            } else {
                // Verificar si es error de autenticación
                if (data.message && data.message.includes('autoritzat')) {
                    showToast('Sessió expirada. Redirigint al login...', 'warning');
                    setTimeout(() => {
                        window.location.href = '../auth/login.html';
                    }, 2000);
                } else {
                    const t = (typeof window.t === 'function') ? window.t : (key) => key;
                    showToast(data.message || t('toast.purchaseError'), 'error');
                }
                closeModal();
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
            }
        })
        .catch(err => {
            console.error('Error en compra:', err);
            showToast(t('toast.connectionError'), 'error');
            closeModal();
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
        });
    }
    
    // Inicializar dropdown de perfil
    function initProfileDropdown() {
      const profileBtn = document.getElementById('profileDropdown');
      const profileMenu = document.getElementById('profileMenu');
      const langMenu = document.getElementById('langMenu');
      
      if (profileBtn && profileMenu) {
        profileBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          profileMenu.style.display = profileMenu.style.display === 'none' ? 'block' : 'none';
          
          if (langMenu) langMenu.style.display = 'none';
        });
      }
      
      console.log('✅ Dropdown de perfil inicializado');
    }

    // Cargar nombre de usuario
    function loadUsername() {
      fetch('../../php/api/session-check.php', { 
        credentials: 'include' 
      })
      .then(res => res.json())
      .then(data => {
        if (data.loggedIn && data.username) {
          const usernameEl = document.getElementById('profileUsername');
          const avatarEl = document.getElementById('profileAvatar');
          
          if (usernameEl) {
            usernameEl.textContent = data.username;
          }
          
          if (avatarEl) {
            avatarEl.textContent = data.username.charAt(0).toUpperCase();
          }
          
          console.log('✅ Usuario cargado:', data.username);
        }
      })
      .catch(err => console.error('Error cargando usuario:', err));
    }

    // Función para cerrar sesión
    function logout() {
      if (confirm('Estàs segur que vols tancar la sessió?')) {
        fetch('../../php/api/logout.php', { 
          method: 'POST',
          credentials: 'include' 
        })
        .then(() => {
          if (typeof showToast === 'function') {
            showToast('Sessió tancada correctament', 'success');
          }
          setTimeout(() => {
            window.location.href = '../auth/login.html';
          }, 1000);
        })
        .catch(err => {
          console.error('Error al cerrar sesión:', err);
          window.location.href = '../auth/login.html';
        });
      }
    }
    
    // Inicializar al cargar
    document.addEventListener('DOMContentLoaded', function() {
        initProfileDropdown();
        loadUsername();
    });
</script>

<style>
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Animación de actualización de puntos */
    #currentPoints {
        transition: opacity 0.3s ease;
    }
</style>

</body>
</html>
