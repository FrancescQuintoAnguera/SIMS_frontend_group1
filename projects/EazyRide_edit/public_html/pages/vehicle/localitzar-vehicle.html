<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzyRide - Localitzar Vehicles</title>
    <link rel="stylesheet" href="../../css/main.css">
    <script src="../../js/toast.js?v=1761166892"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="">
    <style>
        .vehicles-map-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: var(--spacing-md);
            min-height: calc(100vh - 160px);
        }
        
        .vehicles-sidebar {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-height: calc(100vh - 160px);
            overflow: hidden;
        }
        
        .vehicles-list-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: var(--spacing-xs);
        }
        
        .vehicles-list-wrapper::-webkit-scrollbar {
            width: 4px;
        }
        
        .vehicles-list-wrapper::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }
        
        .vehicles-list-wrapper::-webkit-scrollbar-thumb {
            background: var(--color-accent-primary);
            border-radius: 2px;
        }
        
        .map-container {
            position: sticky;
            top: var(--spacing-md);
            height: calc(100vh - 160px);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        
        /* Card Glass más compacto */
        .card-glass {
            padding: var(--spacing-sm) var(--spacing-md);
        }
        
        /* Responsive design */
        @media (max-width: 1024px) {
            .vehicles-map-container {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
                min-height: auto;
            }
            
            .vehicles-sidebar {
                max-height: 45vh;
            }
            
            .vehicles-list-wrapper {
                max-height: 35vh;
            }
            
            .map-container {
                position: relative;
                height: 45vh;
                order: -1;
                top: 0;
            }
        }
        
        @media (max-width: 768px) {
            .vehicles-map-container {
                gap: var(--spacing-sm);
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 40vh;
                min-height: 280px;
            }
            
            .vehicles-sidebar {
                max-height: 42vh;
            }
            
            .vehicles-list-wrapper {
                max-height: 32vh;
            }
        }
        
        @media (max-width: 480px) {
            .vehicles-map-container {
                grid-template-columns: 1fr;
            }
            
            .map-container {
                height: 35vh;
                min-height: 250px;
            }
            
            .vehicles-sidebar {
                max-height: 40vh;
            }
        }
        
        .vehicle-card {
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .vehicle-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--color-accent-primary);
            transform: translateX(3px);
        }
        
        .vehicle-card.selected {
            background: rgba(166, 238, 54, 0.1);
            border-color: var(--color-accent-primary);
        }
        
        .battery-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: var(--spacing-xs);
        }
        
        .battery-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-accent-primary), var(--color-accent-secondary));
            transition: width 0.3s;
        }
        
        /* Filtros compactos */
        .form-group {
            margin-bottom: var(--spacing-sm);
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        .form-label {
            font-size: 0.8125rem;
            margin-bottom: var(--spacing-xs);
        }
        
        .form-input {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <a href="../dashboard/gestio.html" style="display: flex; align-items: center; gap: var(--spacing-md); text-decoration: none;">
                <img src="../../images/logo.png" alt="Logo EzyRide" style="height: 40px; width: 40px; border-radius: var(--radius-md);">
                <h1 style="margin: 0; font-size: 1.5rem; font-weight: 700;">EzyRide</h1>
            </a>
        </div>
        <div class="header-center"><h1 class="page-title">Localitzar Vehicle</h1></div><div class="user-info" style="display: flex; align-items: center; gap: var(--spacing-md);">
            <!-- Selector de idioma -->
            <div class="language-selector" style="position: relative;">
                <button id="langBtn" class="btn btn-ghost" style="padding: var(--spacing-sm) var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-xs);">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    <span id="currentLangText">CA</span>
                </button>
                <div id="langMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 150px; padding: var(--spacing-xs); display: none; z-index: 1000;">
                    <button onclick="changeLanguage('ca')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇪🇸 Català
                    </button>
                    <button onclick="changeLanguage('es')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇪🇸 Español
                    </button>
                    <button onclick="changeLanguage('en')" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        🇬🇧 English
                    </button>
                </div>
            </div>
            
            <!-- Dropdown de perfil -->
            <div style="position: relative;">
                <button id="profileDropdown" class="btn btn-ghost" style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <div id="profileAvatar" style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.875rem;">
                        ...
                    </div>
                    <span id="profileUsername">Cargando...</span>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                <div id="profileMenu" class="card-glass" style="position: absolute; top: calc(100% + 8px); right: 0; min-width: 220px; padding: var(--spacing-xs); display: none; z-index: 1000;">
                    <a href="../profile/perfil.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span>El meu perfil</span>
                    </a>
                    <a href="purchase-time.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Comprar Punts</span>
                    </a>
                    <a href="../profile/premium.html" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md);">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                        <span>Premium</span>
                    </a>
                    <hr style="margin: var(--spacing-sm) 0; border: none; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button onclick="logout()" class="btn btn-ghost" style="width: 100%; justify-content: flex-start; padding: var(--spacing-sm) var(--spacing-md); color: #EF4444;">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Tancar sessió</span>
                    </button>
                </div>
            </div>
            
            <a href="../dashboard/gestio.html" class="btn btn-ghost">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span>Gestió</span>
            </a>
        </div>
    </header>

    <main>
        <div class="container container-full fade-in">
            <!-- Título -->
            <div style="text-align: center; margin-bottom: var(--spacing-md);">
                <p style="color: var(--color-text-secondary); font-size: 0.875rem;">
                    Troba vehicles disponibles prop de tu
                </p>
            </div>

            <div class="vehicles-map-container">
                <!-- Sidebar: Lista y Filtros -->
                <div class="vehicles-sidebar">
                    <!-- Filtres -->
                    <div class="card-glass">
                        <h3 style="font-size: 0.9375rem; margin-bottom: var(--spacing-sm); font-weight: 600;">Filtres</h3>
                        <div class="form-group">
                            <label class="form-label">Distància màxima</label>
                            <select class="form-input" id="distance-filter">
                                <option value="1">1 km</option>
                                <option value="5" selected>5 km</option>
                                <option value="10">10 km</option>
                                <option value="20">20 km</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Bateria mínima</label>
                            <select class="form-input" id="battery-filter">
                                <option value="0" selected>Qualsevol</option>
                                <option value="20">20%</option>
                                <option value="50">50%</option>
                                <option value="80">80%</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Lista de Vehicles -->
                    <div class="card-glass" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                            <h3 style="font-size: 0.9375rem; margin: 0; font-weight: 600;">
                                Vehicles (<span id="vehicles-count">0</span>)
                            </h3>
                            <button id="refresh-list" class="btn btn-ghost" style="padding: var(--spacing-xs); font-size: 0.875rem;">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <polyline points="1 20 1 14 7 14"/>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                </svg>
                            </button>
                        </div>
                        <div class="vehicles-list-wrapper">
                            <div id="vehicles-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Mapa -->
                <div class="map-container">
                    <div class="card-glass" style="height: 100%; display: flex; flex-direction: column;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md); padding-bottom: 0;">
                            <h3 style="font-size: 1.125rem; margin: 0;">Mapa de Vehicles</h3>
                            <button id="refresh-map" class="btn btn-ghost" style="padding: var(--spacing-sm);">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <polyline points="1 20 1 14 7 14"/>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                </svg>
                            </button>
                        </div>
                        <div id="map" style="flex: 1; border-radius: var(--radius-md); overflow: hidden; margin: var(--spacing-md);"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>© 2025 EzyRide. Tots els drets reservats.</p>
    </footer>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        let map;
        let markers = [];
        let vehiclesData = [];
        let allVehiclesData = []; // Guardar todos los vehículos sin filtrar
        let currentFilters = {
            distance: 5,
            battery: 0
        };

        // Inicializar al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
            initDropdowns();
            initMap();
        });

        // Cargar perfil de usuario
        async function loadUserProfile() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('../../php/profile/get_profile.php', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Network error');
                
                const data = await response.json();
                
                if (data && data.nom) {
                    const username = data.nom || data.username || 'Usuario';
                    const usernameEl = document.getElementById('profileUsername');
                    if (usernameEl) usernameEl.textContent = username;
                    
                    const initial = username.charAt(0).toUpperCase();
                    const avatarEl = document.getElementById('profileAvatar');
                    if (avatarEl) avatarEl.textContent = initial;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Set default values on error
                const usernameEl = document.getElementById('profileUsername');
                if (usernameEl) usernameEl.textContent = 'Usuari';
                const avatarEl = document.getElementById('profileAvatar');
                if (avatarEl) avatarEl.textContent = 'U';
            }
        }

        // Inicializar dropdowns
        function initDropdowns() {
            const profileDropdown = document.getElementById('profileDropdown');
            const profileMenu = document.getElementById('profileMenu');
            const langBtn = document.getElementById('langBtn');
            const langMenu = document.getElementById('langMenu');
            
            if (profileDropdown && profileMenu) {
                profileDropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileMenu.style.display = profileMenu.style.display === 'none' ? 'block' : 'none';
                    if (langMenu) langMenu.style.display = 'none';
                });
            }
            
            if (langBtn && langMenu) {
                langBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    langMenu.style.display = langMenu.style.display === 'none' ? 'block' : 'none';
                    if (profileMenu) profileMenu.style.display = 'none';
                });
            }

            document.addEventListener('click', () => {
                if (langMenu) langMenu.style.display = 'none';
                if (profileMenu) profileMenu.style.display = 'none';
            });
        }

        // Función de logout
        function logout() {
            fetch('../../php/auth/logout.php', {
                method: 'POST',
                credentials: 'include'
            })
            .then(() => {
                window.location.href = '../auth/login.html';
            })
            .catch(error => {
                console.error('Error al cerrar sesión:', error);
                window.location.href = '../auth/login.html';
            });
        }

        // Cargar vehículos desde la API
        async function loadVehicles() {
            try {
                const response = await fetch('../../php/api/get-available-vehicles.php', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success && data.vehicles) {
                    allVehiclesData = data.vehicles;
                    applyFilters();
                } else {
                    // Si no hay API, usar datos de ejemplo
                    useMockData();
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
                useMockData();
            }
        }

        function useMockData() {
            allVehiclesData = [
                { id: 1, model: 'Tesla Model 3', battery_level: 85, latitude: 41.3851, longitude: 2.1734, distance: 0.5 },
                { id: 2, model: 'Nissan Leaf', battery_level: 72, latitude: 41.3901, longitude: 2.1640, distance: 1.2 },
                { id: 3, model: 'BMW i3', battery_level: 91, latitude: 41.3801, longitude: 2.1800, distance: 0.8 },
                { id: 4, model: 'Renault Zoe', battery_level: 68, latitude: 41.3950, longitude: 2.1700, distance: 1.5 },
                { id: 5, model: 'Volkswagen ID.3', battery_level: 95, latitude: 41.3800, longitude: 2.1650, distance: 0.9 },
                { id: 6, model: 'Hyundai Kona', battery_level: 45, latitude: 41.3820, longitude: 2.1680, distance: 0.7 },
                { id: 7, model: 'Audi e-tron', battery_level: 88, latitude: 41.3870, longitude: 2.1720, distance: 0.4 },
                { id: 8, model: 'Peugeot e-208', battery_level: 62, latitude: 41.3880, longitude: 2.1760, distance: 1.1 },
            ];
            applyFilters();
        }
        
        function applyFilters() {
            // Filtrar por distancia y batería
            vehiclesData = allVehiclesData.filter(vehicle => {
                const distance = vehicle.distance || parseFloat(vehicle.distance_text) || 0;
                const battery = vehicle.battery_level || 0;
                
                const passDistance = distance <= currentFilters.distance;
                const passBattery = battery >= currentFilters.battery;
                
                return passDistance && passBattery;
            });
            
            // Actualizar contador
            const countEl = document.getElementById('vehicles-count');
            if (countEl) {
                countEl.textContent = vehiclesData.length;
            }
            
            // Renderizar
            renderVehicleMarkers();
            renderVehiclesList();
        }

        function initMap() {
            const centerCoords = [41.3851, 2.1734]; // Barcelona
            map = L.map('map').setView(centerCoords, 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Añadir marcador de usuario
            const userIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `
                    <div style="background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>
                `,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            L.marker(centerCoords, { icon: userIcon }).addTo(map)
                .bindPopup('La teva ubicació')
                .openPopup();

            // Cargar vehículos
            loadVehicles();
        }

        function renderVehicleMarkers() {
            // Limpiar marcadores existentes
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            vehiclesData.forEach(vehicle => {
                const battery = vehicle.battery_level;
                const lat = parseFloat(vehicle.latitude);
                const lng = parseFloat(vehicle.longitude);
                
                const vehicleIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `
                        <div style="position: relative;">
                            <div style="background: ${getBatteryColor(battery)}; width: 40px; height: 40px; border-radius: var(--radius-md); border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                🚗
                            </div>
                            <div style="position: absolute; top: -8px; right: -8px; background: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: ${getBatteryColor(battery)}; box-shadow: 0 1px 4px rgba(0,0,0,0.2);">
                                ${battery}
                            </div>
                        </div>
                    `,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([lat, lng], { icon: vehicleIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="text-align: center; padding: 8px;">
                            <strong>${vehicle.model}</strong><br>
                            <span style="color: ${getBatteryColor(battery)};">🔋 ${battery}%</span><br>
                            <span>📍 ${vehicle.distance || 'Prop'}</span><br>
                            <button onclick="reserveVehicle(${vehicle.id})" style="margin-top: 8px; padding: 6px 12px; background: linear-gradient(135deg, var(--color-accent-primary) 0%, var(--color-accent-secondary) 100%); border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600;">
                                Reservar
                            </button>
                        </div>
                    `);

                markers.push(marker);
            });
        }

        function getBatteryColor(battery) {
            if (battery >= 80) return 'linear-gradient(135deg, #34C759 0%, #30D158 100%)';
            if (battery >= 50) return 'linear-gradient(135deg, #FFD60A 0%, #FFC107 100%)';
            return 'linear-gradient(135deg, #FF453A 0%, #FF3B30 100%)';
        }

        function renderVehiclesList() {
            const list = document.getElementById('vehicles-list');
            if (!vehiclesData.length) {
                list.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-lg); color: var(--color-text-secondary);">
                        <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="margin-bottom: var(--spacing-sm); opacity: 0.5;">
                            <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
                        </svg>
                        <p style="margin: 0; font-size: 0.875rem;">No hi ha vehicles disponibles amb aquests filtres</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = vehiclesData.map(vehicle => {
                const battery = vehicle.battery_level;
                const distance = vehicle.distance || 0;
                const distanceText = typeof distance === 'number' ? `${distance.toFixed(1)} km` : distance;
                
                return `
                <div class="vehicle-card" onclick="focusVehicle(${vehicle.latitude}, ${vehicle.longitude}, ${vehicle.id})" data-vehicle-id="${vehicle.id}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-xs);">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: var(--spacing-xs); margin-bottom: 2px;">
                                <span style="font-size: 1.125rem;">🚗</span>
                                <h4 style="font-size: 0.875rem; margin: 0; font-weight: 600; line-height: 1.2;">${vehicle.model}</h4>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--color-text-secondary); margin: 0; line-height: 1.3;">📍 ${distanceText}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="display: inline-flex; align-items: center; gap: 3px; padding: 3px 8px; background: ${getBatteryColor(battery)}; border-radius: var(--radius-full); font-size: 0.6875rem; font-weight: 600; color: white;">
                                <span>🔋</span>
                                <span>${battery}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="battery-bar" style="margin-bottom: var(--spacing-xs);">
                        <div class="battery-fill" style="width: ${battery}%; background: ${getBatteryColor(battery)};"></div>
                    </div>
                    <button onclick="event.stopPropagation(); reserveVehicle(${vehicle.id})" class="btn btn-primary" style="width: 100%; font-size: 0.8125rem; padding: var(--spacing-xs) var(--spacing-sm);">
                        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="margin-right: 4px;">
                            <path d="M9 11l3 3L22 4"/>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                        </svg>
                        Reservar
                    </button>
                </div>
            `}).join('');
        }

        function focusVehicle(lat, lng, vehicleId) {
            // Centrar mapa
            map.setView([lat, lng], 17);
            
            // Highlight vehicle card
            document.querySelectorAll('.vehicle-card').forEach(card => {
                card.classList.remove('selected');
            });
            const selectedCard = document.querySelector(`[data-vehicle-id="${vehicleId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
        }

        // FUNCIÓN DE RESERVA REAL
        // FUNCIÓN DE RESERVA REAL con fechas correctas
        window.reserveVehicle = async function(vehicleId) {
            const vehicle = vehiclesData.find(v => v.id === vehicleId);
            if (!vehicle) return;

            // Crear fechas de reserva (AHORA, termina en +2 horas)
            const now = new Date();
            const startTime = new Date(now.getTime()); // Empieza AHORA
            const endTime = new Date(now.getTime() + (2 * 60 * 60 * 1000)); // +2 horas

            // Formato: YYYY-MM-DD HH:MM:SS (usa hora local del navegador)
            function formatDateTime(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                const day = String(date.getDate()).padStart(2, "0");
                const hours = String(date.getHours()).padStart(2, "0");
                const minutes = String(date.getMinutes()).padStart(2, "0");
                const seconds = String(date.getSeconds()).padStart(2, "0");
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }

            const startDatetime = formatDateTime(startTime);
            const endDatetime = formatDateTime(endTime);

            console.log("Reservant vehicle:", {
                vehicle_id: vehicleId,
                start_datetime: startDatetime,
                end_datetime: endDatetime
            });

            showToast("Reservant vehicle...", "info");

            try {
                const response = await fetch("../../php/api/book-vehicle.php", {
                    method: "POST",
                    credentials: "include",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        vehicle_id: vehicleId,
                        start_datetime: startDatetime,
                        end_datetime: endDatetime
                    })
                });

                const data = await response.json();
                console.log("Resposta API:", data);

                if (data.success) {
                    showToast(`Vehicle ${vehicle.model} reservat!`, "success");
                    setTimeout(() => {
                        window.location.href = "administrar-vehicle.html";
                    }, 1000);
                } else {
                    // Si ya tiene una reserva activa, redirigir a administrar-vehicle
                    if (response.status === 409 && data.existing_vehicle) {
                        showToast(`Ja tens el ${data.existing_vehicle} reservat`, "warning");
                        setTimeout(() => {
                            window.location.href = "administrar-vehicle.html";
                        }, 1500);
                    } else {
                        showToast(data.message_ca || data.message || "Error al reservar el vehicle", "error");
                        console.error("Error de reserva:", data);
                    }
                }
            } catch (error) {
                console.error("Error de xarxa:", error);
                showToast("Error de connexió", "error");
            }
        };

        // Refresh map y lista
        document.getElementById('refresh-map')?.addEventListener('click', function() {
            showToast('Actualitzant mapa...', 'info');
            loadVehicles();
        });

        document.getElementById('refresh-list')?.addEventListener('click', function() {
            showToast('Actualitzant llista...', 'info');
            loadVehicles();
        });

        // Filtros
        document.getElementById('distance-filter')?.addEventListener('change', function() {
            currentFilters.distance = parseInt(this.value);
            applyFilters();
            showToast(`Filtrant per ${this.value} km`, 'info');
        });

        document.getElementById('battery-filter')?.addEventListener('change', function() {
            currentFilters.battery = parseInt(this.value);
            applyFilters();
            showToast(`Filtrant per bateria mínima ${this.value}%`, 'info');
        });
    </script>

    <style>
        /* Scrollbar personalizado para la lista */
        .vehicles-list-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .vehicles-list-wrapper::-webkit-scrollbar-thumb {
            background: var(--color-border-default);
            border-radius: var(--radius-full);
        }
        
        .vehicles-list-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        #vehicles-list::-webkit-scrollbar-thumb {
            background: var(--color-border-default);
            border-radius: var(--radius-full);
        }
    </style>
</body>
</html>
